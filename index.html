<script>
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0";
const SHEET_NAMES = { audit: "1", checkin: "2", ncr: "3" };
const COLMAP = {
  audit_date: "Data",
  audit_total: "Peças Auditadas (dia) TOTAL",
  audit_cald: "CALÇADOS",
  audit_vest: "VESTUARIOS",
  audit_acess: "ACESSORIOS",
  audit_supl: "SUPLEMENTOS",
  audit_phh: "Peças por Hora",
  audit_rnc_count: "quantidade de RNC GERADAS",
  audit_fotos: "fotos"
};

function gsheetCsvUrl(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}
function fetchCsvAsJson(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

// Utilitário para converter "dd/mm/aaaa" em objeto Date
function parsePtBrDate(str) {
  if (!str) return null;
  const [d, m, y] = str.split("/").map(Number);
  return new Date(y, m - 1, d);
}

function computeKpis(auditRows, checkinRows, ncrRows) {
  let totalAuditadas = 0;
  let categoriesAudit = { CALÇADOS: 0, VESTUARIOS: 0, ACESSORIOS: 0, SUPLEMENTOS: 0 };
  let phhList = [];
  let rncSum = 0, fotosSum = 0;
  let datas = [];

  auditRows.forEach(r => {
    const toNumber = v => Number(String(v || "0").replace(",", ".").replace(/\s/g, "")) || 0;
    totalAuditadas += toNumber(r[COLMAP.audit_total]);
    categoriesAudit.CALÇADOS += toNumber(r[COLMAP.audit_cald]);
    categoriesAudit.VESTUARIOS += toNumber(r[COLMAP.audit_vest]);
    categoriesAudit.ACESSORIOS += toNumber(r[COLMAP.audit_acess]);
    categoriesAudit.SUPLEMENTOS += toNumber(r[COLMAP.audit_supl]);
    const ph = toNumber(r[COLMAP.audit_phh]); if (ph) phhList.push(ph);
    rncSum += toNumber(r[COLMAP.audit_rnc_count]);
    fotosSum += toNumber(r[COLMAP.audit_fotos]);
    if (r[COLMAP.audit_date]) datas.push(r[COLMAP.audit_date]);
  });

  const toNumber = v => Number(String(v || "0").replace(",", ".").replace(/\s/g, "")) || 0;
  const checkByDate = {};
  checkinRows.forEach(r => {
    const d = r["Data"] || "";
    if (!d) return;
    if (!checkByDate[d]) checkByDate[d] = { total: 0, CALÇADOS: 0, VESTUARIOS: 0, ACESSORIOS: 0, SUPLEMENTOS: 0 };
    const totalField = r["CONFERIDAS TOTAL"] ?? r["CONFERIDAS"] ?? 0;
    checkByDate[d].total += toNumber(totalField);
    checkByDate[d].CALÇADOS += toNumber(r["CALÇADOS"]);
    checkByDate[d].VESTUARIOS += toNumber(r["VESTUARIOS"]);
    checkByDate[d].ACESSORIOS += toNumber(r["ACESSORIOS"]);
    checkByDate[d].SUPLEMENTOS += toNumber(r["SUPLEMENTOS"]);
  });

  let totalConferidas = 0;
  const check_categories = { CALÇADOS: 0, VESTUARIOS: 0, ACESSORIOS: 0, SUPLEMENTOS: 0 };
  Object.values(checkByDate).forEach(v => {
    totalConferidas += v.total;
    check_categories.CALÇADOS += v.CALÇADOS;
    check_categories.VESTUARIOS += v.VESTUARIOS;
    check_categories.ACESSORIOS += v.ACESSORIOS;
    check_categories.SUPLEMENTOS += v.SUPLEMENTOS;
  });

  const fornecedores = {};
  const tipos = {};
  let totalAvariados = 0;
  ncrRows.forEach(r => {
    const qtd = toNumber(r["QNTD"]);
    const f = r["FORNECEDOR"] || "SEM FORNECEDOR";
    const t = r["TIPO DE AVARIA"] || "OUTRO";
    fornecedores[f] = (fornecedores[f] || 0) + qtd;
    tipos[t] = (tipos[t] || 0) + qtd;
    totalAvariados += qtd;
  });

  const taxaNaoConformidade = totalAuditadas > 0 ? totalAvariados / totalAuditadas : 0;
  const mediaPhh = phhList.length ? phhList.reduce((a, b) => a + b, 0) / phhList.length : 0;
  const pctAuditadoSobreConferido = totalConferidas > 0 ? totalAuditadas / totalConferidas : 0;

  return {
    period: { min: datas[0] || null, max: datas[datas.length - 1] || null },
    totalAuditadas, categoriesAudit, mediaPhh,
    totalConferidas, check_categories, totalAvariados,
    taxaNaoConformidade, rncSum, fotosSum, fornecedores, tipos,
    pctAuditadoSobreConferido
  };
}

function renderKpis(k) {
  document.getElementById('kpi-pecas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('kpi-hh').innerText = k.mediaPhh ? k.mediaPhh.toFixed(1) : '--';
  document.getElementById('rnc-num').innerText = k.rncSum;
  document.getElementById('fotos-num').innerText = k.fotosSum;
  document.getElementById('sum-conferidas').innerText = k.totalConferidas.toLocaleString('pt-BR');
  document.getElementById('sum-auditadas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('pct-auditado').innerText = (k.pctAuditadoSobreConferido * 100).toFixed(1) + '%';
  document.getElementById('kpi-taxa').innerText = (k.taxaNaoConformidade * 100).toFixed(1) + '%';
  document.getElementById('kpi-taxa-qnt').innerText = `${k.totalAvariados} peças`;
  document.getElementById('periodo-text').innerText = (k.period.min && k.period.max) ? `${k.period.min} → ${k.period.max}` : '--';
}

let chartCheckin = null;
let chartCats = null;

function drawCharts(k, auditRows, checkinRows) {
  const dates = auditRows.map(r => r["Data"]).filter(Boolean);
  if (!dates.length) return;
  const byDate = {};
  auditRows.forEach(r => {
    const d = r["Data"];
    if (!d) return;
    if (!byDate[d]) byDate[d] = { audit: 0, ph: 0 };
    byDate[d].audit += Number(r[COLMAP.audit_total] || 0);
    byDate[d].ph += Number(r[COLMAP.audit_phh] || 0);
  });
  const labels = Object.keys(byDate);
  const auditData = labels.map(l => byDate[l].audit);
  const phData = labels.map(l => byDate[l].ph);

  const checkByDate = {};
  checkinRows.forEach(r => {
    const d = r["Data"];
    if (!d) return;
    checkByDate[d] = (checkByDate[d] || 0) + Number(r["CONFERIDAS"] || r["CONFERIDAS TOTAL"] || 0);
  });
  const checkinData = labels.map(l => checkByDate[l] || 0);

  const ctx = document.getElementById('chart-checkin').getContext('2d');
  if (chartCheckin) chartCheckin.destroy();
  chartCheckin = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Conferidas', data: checkinData, backgroundColor: '#1976d2' },
        { label: 'Auditadas', data: auditData, backgroundColor: '#0b5f3a' },
        { label: 'Média Pçs H/H', data: phData, type: 'line', borderColor: 'gold', tension: 0.3 }
      ]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: function (context) {
              const label = context.dataset.label;
              const val = context.parsed.y;
              if (label === 'Auditadas') {
                const conf = checkinData[context.dataIndex];
                const pct = conf > 0 ? ((val / conf) * 100).toFixed(1) : 0;
                return `${label}: ${val.toLocaleString('pt-BR')} (${pct}%)`;
              }
              return `${label}: ${val.toLocaleString('pt-BR')}`;
            }
          }
        }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  const catLabels = ['CALÇADOS', 'VESTUARIOS', 'ACESSORIOS', 'SUPLEMENTOS'];
  const catData = catLabels.map(c => k.check_categories[c] || 0);
  const ctx2 = document.getElementById('chart-categories').getContext('2d');
  if (chartCats) chartCats.destroy();
  chartCats = new Chart(ctx2, {
    type: 'bar',
    data: { labels: catLabels, datasets: [{ data: catData, backgroundColor: '#8b0000' }] },
    options: { plugins: { legend: { display: false } } }
  });
}

async function initDashboard(startDate = null, endDate = null) {
  const [auditRows, checkinRows, ncrRows] = await Promise.all([
    fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.audit)),
    fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.checkin)),
    fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.ncr))
  ]);

  // Filtra pelas datas selecionadas
  if (startDate && endDate) {
    const inRange = r => {
      const d = parsePtBrDate(r["Data"]);
      return d && d >= startDate && d <= endDate;
    };
    auditRows = auditRows.filter(inRange);
    checkinRows = checkinRows.filter(inRange);
    ncrRows = ncrRows.filter(inRange);
  }

  const k = computeKpis(auditRows, checkinRows, ncrRows);
  renderKpis(k);
  drawCharts(k, auditRows, checkinRows);
}

// cria os campos de data no header
window.addEventListener('DOMContentLoaded', () => {
  const header = document.querySelector('header div div');
  const filterHtml = `
    <div style="margin-top:6px;font-size:13px;color:#666;">
      De <input type="date" id="startDate"> até <input type="date" id="endDate">
      <button id="applyDate" style="background:#001C40;color:#A4FF00;border:none;padding:2px 8px;border-radius:6px;cursor:pointer">Aplicar</button>
    </div>`;
  header.insertAdjacentHTML('beforeend', filterHtml);
  document.getElementById('applyDate').addEventListener('click', () => {
    const s = document.getElementById('startDate').valueAsDate;
    const e = document.getElementById('endDate').valueAsDate;
    if (!s || !e) return alert("Selecione as duas datas.");
    initDashboard(s, e);
  });
  initDashboard(); // inicializa padrão
});
</script>
