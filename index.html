<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DASHBOARD CONTROLE DE QUALIDADE NOTURNO - FutFanatics</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --navy: #001C40;
      --accent: #A4FF00;
      --muted: #f5f6f7;
      --card-radius: 12px;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);color:var(--navy);padding:18px;}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px;}
    header h1{margin:0;font-size:20px;color:var(--navy);}
    .grid{display:grid;grid-template-columns:320px 1fr 420px;gap:18px;align-items:start;}
    .col-left,.col-center,.col-right{display:flex;flex-direction:column;gap:18px;}
    .card{background:#fff;border-radius:var(--card-radius);box-shadow:var(--card-shadow);padding:16px;border:2px solid rgba(0,0,0,0.04);}
    .kpi-large{font-size:48px;font-weight:700;text-align:center;color:var(--navy);}
    .kpi-label{text-align:center;font-size:13px;color:#333;margin-top:6px;}
    .mini-list{display:flex;flex-direction:column;gap:6px;margin-top:6px;}
    .mini-item{display:flex;justify-content:space-between;padding:6px;background:var(--muted);border-radius:8px;font-size:13px;}
    .small-title{font-weight:700;color:var(--navy);font-size:13px;margin-bottom:8px;}
    footer{margin-top:18px;font-size:12px;color:#666;}
    @media(max-width:1100px){.grid{grid-template-columns:1fr;}}
    .filter-box{font-size:13px;color:#666;margin-top:4px;}
    .filter-box input{padding:4px 6px;border:1px solid #ccc;border-radius:6px;}
    .filter-box button{padding:4px 8px;border:none;border-radius:6px;background:var(--navy);color:#fff;cursor:pointer;}
    .filter-box button:hover{background:#023366;}
  </style>
</head>

<body>
  <header>
    <img src="FUT.jfif" alt="Logo" style="width:44px;height:44px;background:var(--navy);border-radius:8px">
    <div>
      <h1>DASHBOARD CONTROLE DE QUALIDADE NOTURNO - FutFanatics</h1>
      <div class="filter-box">
        <label>Período:</label>
        <input type="date" id="startDate"> até
        <input type="date" id="endDate">
        <button onclick="applyFilter()">Filtrar</button>
        <button style="background:#777" onclick="clearFilter()">Mostrar tudo</button>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="col-left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:12px;color:#666">PEÇAS AUDITADAS</div>
            <div class="kpi-large" id="kpi-pecas">--</div>
            <div class="kpi-label">total do período</div>
          </div>
          <div style="width:120px">
            <div style="font-size:12px;color:#666">TAXA DE NÃO CONFORMIDADE</div>
            <div style="font-weight:700;font-size:24px;color:var(--navy)" id="kpi-taxa">--</div>
            <div style="font-size:12px;color:#999" id="kpi-taxa-qnt">--</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="small-title">Distribuição por categoria</div>
          <div class="mini-list" id="categoria-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="small-title">Top 3 Fornecedores Críticos</div>
        <div id="fornecedores-list"></div>
        <div style="margin-top:12px" class="small-title">Tipos de Avaria mais frequentes</div>
        <div id="tipos-list"></div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="col-center">
      <div class="card">
        <div class="small-title">Peças Conferidas (Check-in) vs Peças Auditadas</div>
        <canvas id="chart-checkin" height="150"></canvas>
        <div style="font-size:12px;color:#666;margin-top:8px" id="meta-note"></div>
      </div>

      <div class="card" style="display:flex;gap:12px;align-items:center;">
        <div style="flex:1">
          <div class="small-title">Peças por Categoria (Check-in)</div>
          <canvas id="chart-categories" height="120"></canvas>
        </div>
        <div style="width:220px">
          <div class="small-title">RNC / FOTOS (OR)</div>
          <div style="font-size:24px;font-weight:700;color:var(--navy)"><span id="rnc-num">--</span> RNC</div>
          <div style="font-size:24px;font-weight:700;color:var(--navy)"><span id="fotos-num">--</span> FOTOS</div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-right">
      <div class="card">
        <div class="small-title">Média Peças H/H</div>
        <div style="font-size:36px;font-weight:800;color:var(--navy)" id="kpi-hh">--</div>
      </div>

      <div class="card">
        <div class="small-title">Resumo rápido</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;justify-content:space-between"><div>Peças Conferidas</div><div id="sum-conferidas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>Peças Auditadas</div><div id="sum-auditadas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>% Auditado</div><div id="pct-auditado">--</div></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Gerado automaticamente. Atualize o Google Sheets para atualizar os dados.</footer>

<script>
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0";
const SHEET_NAMES = { audit: "1", checkin: "2", ncr: "3" };
const COLMAP = {
  audit_date: "Data",
  audit_total: "Peças Auditadas (dia) TOTAL",
  audit_phh: "Peças por Hora",
  audit_rnc_count: "quantidade de RNC GERADAS",
  audit_fotos: "fotos",
  audit_cald: "CALÇADOS",
  audit_vest: "VESTUARIOS",
  audit_acess: "ACESSORIOS",
  audit_supl: "SUPLEMENTOS"
};
let auditDataAll=[], checkinDataAll=[], ncrDataAll=[];

function gsheetCsvUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}
function parseCsv(url){
  return new Promise((res,rej)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej});
  });
}
function parseDate(str){
  if(!str) return null;
  const [d,m,y]=str.split("/").map(Number);
  return new Date(y,m-1,d);
}
function formatDate(d){
  return d?d.toLocaleDateString("pt-BR"):"--";
}
function applyFilter(){
  const sd=document.getElementById("startDate").value;
  const ed=document.getElementById("endDate").value;
  if(!sd||!ed){alert("Selecione as duas datas.");return;}
  const start=new Date(sd), end=new Date(ed);
  const fAudit=auditDataAll.filter(r=>{
    const dt=parseDate(r[COLMAP.audit_date]);
    return dt && dt>=start && dt<=end;
  });
  const fCheck=checkinDataAll.filter(r=>{
    const dt=parseDate(r["Data"]);
    return dt && dt>=start && dt<=end;
  });
  const fNcr=ncrDataAll.filter(r=>{
    const dt=parseDate(r["Data"]);
    return dt && dt>=start && dt<=end;
  });
  const k=computeKpis(fAudit,fCheck,fNcr);
  renderKpis(k);
  drawCharts(k,fAudit,fCheck,fNcr);
}
function clearFilter(){
  document.getElementById("startDate").value="";
  document.getElementById("endDate").value="";
  const k=computeKpis(auditDataAll,checkinDataAll,ncrDataAll);
  renderKpis(k);
  drawCharts(k,auditDataAll,checkinDataAll,ncrDataAll);
}

function computeKpis(auditRows,checkinRows,ncrRows){
  const toNum=v=>Number(String(v||"0").replace(",",".").replace(/\s/g,""))||0;
  let totalAudit=0, totalConf=0, totalAvar=0, rnc=0, fotos=0, phh=[], cats={CALÇADOS:0,VESTUARIOS:0,ACESSORIOS:0,SUPLEMENTOS:0}, checkCats={CALÇADOS:0,VESTUARIOS:0,ACESSORIOS:0,SUPLEMENTOS:0};
  let forn={}, tipos={}, dates=[];
  auditRows.forEach(r=>{
    totalAudit+=toNum(r[COLMAP.audit_total]);
    rnc+=toNum(r[COLMAP.audit_rnc_count]);
    fotos+=toNum(r[COLMAP.audit_fotos]);
    cats.CALÇADOS+=toNum(r[COLMAP.audit_cald]);
    cats.VESTUARIOS+=toNum(r[COLMAP.audit_vest]);
    cats.ACESSORIOS+=toNum(r[COLMAP.audit_acess]);
    cats.SUPLEMENTOS+=toNum(r[COLMAP.audit_supl]);
    const p=toNum(r[COLMAP.audit_phh]); if(p) phh.push(p);
    if(r[COLMAP.audit_date]) dates.push(r[COLMAP.audit_date]);
  });
  checkinRows.forEach(r=>{
    totalConf+=toNum(r["CONFERIDAS TOTAL"]||r["CONFERIDAS"]||0);
    checkCats.CALÇADOS+=toNum(r["CALÇADOS"]);
    checkCats.VESTUARIOS+=toNum(r["VESTUARIOS"]);
    checkCats.ACESSORIOS+=toNum(r["ACESSORIOS"]);
    checkCats.SUPLEMENTOS+=toNum(r["SUPLEMENTOS"]);
  });
  ncrRows.forEach(r=>{
    const q=toNum(r["QNTD"]);
    const f=r["FORNECEDOR"]||"SEM FORNECEDOR";
    const t=r["TIPO DE AVARIA"]||"OUTRO";
    forn[f]=(forn[f]||0)+q;
    tipos[t]=(tipos[t]||0)+q;
    totalAvar+=q;
  });
  const taxa=totalAudit?totalAvar/totalAudit:0;
  const mediaPhh=phh.length?phh.reduce((a,b)=>a+b)/phh.length:0;
  const pct=totalConf?totalAudit/totalConf:0;
  return {
    totalAuditadas:totalAudit,
    totalConferidas:totalConf,
    taxaNaoConformidade:taxa,
    totalAvariados:totalAvar,
    rncSum:rnc,fotosSum:fotos,
    mediaPhh,
    pctAuditadoSobreConferido:pct,
    categoriesAudit:cats,check_categories:checkCats,
    fornecedores:forn,tipos:tipos,
    period:{min:dates[0],max:dates[dates.length-1]}
  };
}

function renderKpis(k){
  document.getElementById("kpi-pecas").innerText=k.totalAuditadas.toLocaleString("pt-BR");
  document.getElementById("kpi-taxa").innerText=(k.taxaNaoConformidade*100).toFixed(1)+"%";
  document.getElementById("kpi-taxa-qnt").innerText=`${k.totalAvariados} peças`;
  document.getElementById("rnc-num").innerText=k.rncSum;
  document.getElementById("fotos-num").innerText=k.fotosSum;
  document.getElementById("kpi-hh").innerText=k.mediaPhh.toFixed(1);
  document.getElementById("sum-conferidas").innerText=k.totalConferidas.toLocaleString("pt-BR");
  document.getElementById("sum-auditadas").innerText=k.totalAuditadas.toLocaleString("pt-BR");
  document.getElementById("pct-auditado").innerText=(k.pctAuditadoSobreConferido*100).toFixed(1)+"%";
  const cat=document.getElementById("categoria-list");cat.innerHTML="";
  Object.keys(k.categoriesAudit).forEach(c=>{
    cat.innerHTML+=`<div class='mini-item'><div>${c}</div><div>${k.categoriesAudit[c]}</div></div>`;
  });
  const fornArr=Object.entries(k.fornecedores).sort((a,b)=>b[1]-a[1]).slice(0,3);
  document.getElementById("fornecedores-list").innerHTML=fornArr.map((f,i)=>`<div>${i+1}º - ${f[0]} <b>${f[1]}</b></div>`).join("");
  const tipoArr=Object.entries(k.tipos).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById("tipos-list").innerHTML=tipoArr.map(t=>`<div>${t[0]} <b>${t[1]}</b></div>`).join("");
}
let chartCheckin=null,chartCats=null;
function drawCharts(k,auditRows,checkinRows){
  const ctx=document.getElementById("chart-checkin").getContext("2d");
  if(chartCheckin)chartCheckin.destroy();
  const dates=auditRows.map(r=>r["Data"]).filter(Boolean);
  const audits=auditRows.map(r=>Number(r[COLMAP.audit_total]||0));
  const confs=checkinRows.map(r=>Number(r["CONFERIDAS TOTAL"]||r["CONFERIDAS"]||0));
  chartCheckin=new Chart(ctx,{type:"bar",data:{labels:dates,datasets:[
    {label:"Conferidas",data:confs,backgroundColor:"#1976d2"},
    {label:"Auditadas",data:audits,backgroundColor:"#0b5f3a"}
  ]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
  const ctx2=document.getElementById("chart-categories").getContext("2d");
  if(chartCats)chartCats.destroy();
  chartCats=new Chart(ctx2,{type:"bar",data:{labels:Object.keys(k.check_categories),datasets:[{data:Object.values(k.check_categories),backgroundColor:"#8b0000"}]},options:{plugins:{legend:{display:false}}}});
}

async function init(){
  const [a,c,n]=await Promise.all([
    parseCsv(gsheetCsvUrl(SHEET_NAMES.audit)),
    parseCsv(gsheetCsvUrl(SHEET_NAMES.checkin)),
    parseCsv(gsheetCsvUrl(SHEET_NAMES.ncr))
  ]);
  auditDataAll=a; checkinDataAll=c; ncrDataAll=n;
  const k=computeKpis(a,c,n);
  renderKpis(k);
  drawCharts(k,a,c);
}
init();
</script>
</body>
</html>
