<script>
/* ================================================================
   CONFIGURAÇÃO PRINCIPAL
   ================================================================ 
*/
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0";

// ATENÇÃO: Os nomes aqui devem ser IDÊNTICOS aos das abas no Google Sheets
const SHEET_NAMES = {
  audit: "1",
  checkin: "2",
  ncr: "3",
  history: "HISTÓRICO_ANUAL" // Verifique se tem acento no seu Sheets
};

/* --- URL HELPER --- */
function gsheetCsvUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}

/* --- LEITOR DE CSV MELHORADO --- */
function fetchCsvAsJson(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true, // Pula linhas vazias
      complete: function(results){
        if(results.data && results.data.length > 0) {
          resolve(results.data);
        } else {
          reject(`A aba parece vazia ou não foi encontrada. Verifique o nome.`);
        }
      },
      error: function(err){ reject(err); }
    });
  });
}

/* --- LIMPEZA DE DADOS (Converte "1.200,50" ou "30%" para número) --- */
const cleanNum = (v) => {
  if(!v) return 0;
  if(typeof v === 'number') return v;
  // Remove %, R$, espaços e converte vírgula decimal para ponto
  let s = String(v).replace('%','').replace('R$','').replace(/\./g,'').replace(',','.').trim();
  return Number(s) || 0;
};

/* --- CÁLCULO DE KPIS DIÁRIOS --- */
function computeKpis(auditRows, checkinRows, ncrRows){
  let totalAuditadas = 0;
  let categoriesAudit = {CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0};
  let rncSum = 0; 
  let fotosSum = 0;
  let phhSum = 0; 
  let phhCount = 0;
  
  // Mapeamento flexível de colunas (tenta achar a coluna mesmo se mudar maiuscula/minuscula)
  const getCol = (row, keyPart) => {
    const key = Object.keys(row).find(k => k.toUpperCase().includes(keyPart.toUpperCase()));
    return key ? row[key] : null;
  };

  // 1. Processar Auditoria (Aba 1)
  auditRows.forEach(r => {
    // Tenta pegar o total auditado
    let val = cleanNum(getCol(r, "TOTAL") || getCol(r, "AUDITADAS"));
    totalAuditadas += val;
    
    // Categorias
    categoriesAudit.CALÇADOS += cleanNum(getCol(r, "CALÇADO"));
    categoriesAudit.VESTUARIOS += cleanNum(getCol(r, "VESTUARIO"));
    categoriesAudit.ACESSORIOS += cleanNum(getCol(r, "ACESSORIO"));
    categoriesAudit.SUPLEMENTOS += cleanNum(getCol(r, "SUPLEMENTO"));

    // RNC / Fotos
    rncSum += cleanNum(getCol(r, "RNC"));
    fotosSum += cleanNum(getCol(r, "FOTO"));
    
    // PHH
    let ph = cleanNum(getCol(r, "HORA")); // Procura coluna com nome "Hora"
    if(ph > 0) { phhSum += ph; phhCount++; }
  });

  // 2. Processar Check-in (Aba 2)
  let totalConferidas = 0;
  const check_categories = { CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0 };
  
  // Agrupamento por data para gráfico
  const checkByDate = {}; 
  const auditByDate = {}; // Para o gráfico comparativo

  checkinRows.forEach(r => {
    // Tenta achar coluna de data e conferidas
    let dataVal = getCol(r, "DATA");
    let confVal = cleanNum(getCol(r, "CONFERIDAS") || getCol(r, "TOTAL"));
    
    totalConferidas += confVal;

    // Categorias Checkin
    check_categories.CALÇADOS += cleanNum(getCol(r, "CALÇADO"));
    check_categories.VESTUARIOS += cleanNum(getCol(r, "VESTUARIO"));
    check_categories.ACESSORIOS += cleanNum(getCol(r, "ACESSORIO"));
    check_categories.SUPLEMENTOS += cleanNum(getCol(r, "SUPLEMENTO"));

    if(dataVal) {
      checkByDate[dataVal] = (checkByDate[dataVal] || 0) + confVal;
    }
  });

  // Prepara dados de auditoria por data
  auditRows.forEach(r => {
    let dataVal = getCol(r, "DATA");
    let audVal = cleanNum(getCol(r, "TOTAL") || getCol(r, "AUDITADAS"));
    if(dataVal) auditByDate[dataVal] = (auditByDate[dataVal] || 0) + audVal;
  });

  // 3. Processar NCR (Aba 3)
  const fornecedores = {};
  const tipos = {};
  let totalAvariados = 0;
  
  ncrRows.forEach(r => {
    let qtd = cleanNum(getCol(r, "QNT") || getCol(r, "QUANTIDADE"));
    let forn = getCol(r, "FORNECEDOR") || "ND";
    let tipo = getCol(r, "TIPO") || "OUTRO"; // Pega "TIPO DE AVARIA"
    
    fornecedores[forn] = (fornecedores[forn] || 0) + qtd;
    tipos[tipo] = (tipos[tipo] || 0) + qtd;
    totalAvariados += qtd;
  });

  return {
    totalAuditadas,
    totalConferidas,
    pctAuditado: totalConferidas ? (totalAuditadas/totalConferidas) : 0,
    mediaPhh: phhCount ? (phhSum/phhCount) : 0,
    rncSum, fotosSum,
    categoriesAudit, check_categories,
    fornecedores, tipos,
    totalAvariados,
    taxaNconf: totalAuditadas ? (totalAvariados/totalAuditadas) : 0,
    checkByDate, auditByDate // Dados para gráficos
  };
}

/* --- RENDERIZAR NA TELA --- */
function renderDashboard(k, historyRows) {
  // KPIs
  document.getElementById('kpi-pecas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('kpi-hh').innerText = k.mediaPhh.toFixed(1);
  document.getElementById('rnc-num').innerText = k.rncSum;
  document.getElementById('fotos-num').innerText = k.fotosSum;
  
  document.getElementById('sum-conferidas').innerText = k.totalConferidas.toLocaleString('pt-BR');
  document.getElementById('sum-auditadas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('pct-auditado').innerText = (k.pctAuditado*100).toFixed(1)+'%';
  
  document.getElementById('kpi-taxa').innerText = (k.taxaNconf*100).toFixed(1)+'%';
  document.getElementById('kpi-taxa-qnt').innerText = k.totalAvariados + " peças";

  // Listas (Categorias)
  const catList = document.getElementById('categoria-list'); catList.innerHTML = '';
  for(let c in k.categoriesAudit){
    catList.innerHTML += `<div class="mini-item"><b>${c}</b><span>${k.categoriesAudit[c]}</span></div>`;
  }

  // Top Fornecedores
  const fornList = document.getElementById('fornecedores-list'); fornList.innerHTML = '';
  Object.entries(k.fornecedores).sort((a,b)=>b[1]-a[1]).slice(0,3).forEach((f,i)=>{
    fornList.innerHTML += `<div style="display:flex;justify-content:space-between;padding:5px 0">
      <span>${i+1}º ${f[0]}</span><b>${f[1]}</b></div>`;
  });

  // Top Avarias
  const tipoList = document.getElementById('tipos-list'); tipoList.innerHTML = '';
  Object.entries(k.tipos).sort((a,b)=>b[1]-a[1]).slice(0,6).forEach(t=>{
    tipoList.innerHTML += `<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:13px">
      <span>${t[0]}</span><span>${t[1]}</span></div>`;
  });

  // --- GRÁFICOS ---
  drawChartCheckin(k.checkByDate, k.auditByDate);
  drawChartCategories(k.check_categories);
  drawChartAnnual(historyRows);
}

// Gráfico 1: Barras Diárias
let chart1 = null;
function drawChartCheckin(checkData, auditData) {
  const labels = [...new Set([...Object.keys(checkData), ...Object.keys(auditData)])].sort();
  const cData = labels.map(l => checkData[l]||0);
  const aData = labels.map(l => auditData[l]||0);

  if(chart1) chart1.destroy();
  chart1 = new Chart(document.getElementById('chart-checkin'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Conferidas', data: cData, backgroundColor: '#1976d2' },
        { label: 'Auditadas', data: aData, backgroundColor: '#0b5f3a' }
      ]
    },
    options: { responsive:true, plugins:{ legend:{position:'top'} } }
  });
}

// Gráfico 2: Categorias
let chart2 = null;
function drawChartCategories(cats) {
  if(chart2) chart2.destroy();
  chart2 = new Chart(document.getElementById('chart-categories'), {
    type: 'bar',
    data: {
      labels: Object.keys(cats),
      datasets: [{ label: 'Qtd', data: Object.values(cats), backgroundColor: '#8b0000' }]
    },
    options: { plugins:{legend:{display:false}} }
  });
}

// Gráfico 3: LINHA DO TEMPO MENSAL (Novo)
let chart3 = null;
function drawChartAnnual(rows) {
  if(!rows || rows.length === 0) return;

  // Tenta encontrar as colunas independente de maiuscula/minuscula
  const getVal = (r, keyLike) => {
    const k = Object.keys(r).find(key => key.toUpperCase().includes(keyLike.toUpperCase()));
    return cleanNum(r[k]);
  };
  const getLabel = (r) => {
    const k = Object.keys(r).find(key => key.toUpperCase().includes("MES") || key.toUpperCase().includes("MÊS"));
    return r[k];
  };

  const labels = rows.map(r => getLabel(r));
  const conf = rows.map(r => getVal(r, "CONFERIDA"));
  const aud = rows.map(r => getVal(r, "AUDITADA") && !Object.keys(r).find(k=>k.includes("%") && r[k]===getVal(r,"AUDITADA")) ? getVal(r,"AUDITADA") : getVal(r,"AUDITADAS"));
  
  // Para NCONF %, procuramos algo que tenha "%" ou "% NCONF"
  const nconfPct = rows.map(r => {
    // Procura chave que tenha "%" e "NCONF"
    const k = Object.keys(r).find(key => key.toUpperCase().includes("NCONF") && key.includes("%"));
    return cleanNum(r[k] || r["% NCONF"] || r["%NCONF"]);
  });

  if(chart3) chart3.destroy();
  
  const ctx = document.getElementById('chart-monthly').getContext('2d');
  chart3 = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Peças Conferidas',
          data: conf,
          backgroundColor: '#3e73c3',
          order: 2,
          yAxisID: 'y'
        },
        {
          label: 'Peças Auditadas',
          data: aud,
          backgroundColor: '#8ad05b',
          order: 3,
          yAxisID: 'y'
        },
        {
          label: '% Não Conformes',
          data: nconfPct,
          type: 'bar', // Barra vermelha fina
          backgroundColor: '#ff0000',
          borderColor: '#ff0000',
          borderWidth: 1,
          barPercentage: 0.5,
          order: 1,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { type:'linear', display:true, position:'left', beginAtZero:true },
        y1: { 
          type:'linear', display:true, position:'right', beginAtZero:true,
          grid: { drawOnChartArea: false }, // Esconde grade do eixo secundário
          ticks: { callback: v => v + '%' }
        }
      }
    }
  });
}

/* --- INICIALIZAR --- */
async function init(){
  try {
    // Carrega tudo em paralelo
    const p1 = fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.audit));
    const p2 = fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.checkin));
    const p3 = fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.ncr));
    const p4 = fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.history));

    const [audit, checkin, ncr, history] = await Promise.all([p1, p2, p3, p4]);

    // Se chegou aqui, carregou os dados. Calcula e desenha.
    const kpis = computeKpis(audit, checkin, ncr);
    renderDashboard(kpis, history);

  } catch (error) {
    console.error(error);
    // Mostra erro visualmente para o usuário
    document.body.innerHTML = `
      <div style="background:#ffebee; color:#c62828; padding:20px; border:2px solid #ef5350; border-radius:8px; font-family:sans-serif;">
        <h2>⚠️ Ops! Algo deu errado ao carregar os dados.</h2>
        <p><b>Erro detectado:</b> ${error}</p>
        <hr style="border:0; border-top:1px solid #ffcdd2; margin:10px 0;">
        <h3>Como corrigir:</h3>
        <ol>
          <li>Verifique se o nome da aba nova é exatamente <code>HISTÓRICO_ANUAL</code> (com acento).</li>
          <li>Vá em <b>Arquivo > Compartilhar > Publicar na Web</b> na sua planilha e certifique-se que está publicado.</li>
          <li>Verifique se os cabeçalhos da aba nova são: <code>MES</code>, <code>CONFERIDAS</code>, <code>AUDITADAS</code>, <code>% NCONF</code>.</li>
        </ol>
      </div>
    `;
  }
}

init();
</script>
