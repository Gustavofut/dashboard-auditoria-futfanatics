<script>
/*
  CONFIGURE AQUI:
  - ID da planilha Google
*/
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0";

/* Nomes das abas (Devem ser EXATOS como no Google Sheets)
  Adicionei a aba "history" para o histórico anual
*/
const SHEET_NAMES = {
  audit: "1",
  checkin: "2",
  ncr: "3",
  history: "HISTORICO_ANUAL" // Nome da nova aba
};

/* Mapeamento de colunas (Aba 1 - Auditoria) */
const COLMAP = {
  audit_date: "Data",
  audit_total: "Peças Auditadas (dia) TOTAL",
  audit_cald: "CALÇADOS",
  audit_vest: "VESTUARIOS",
  audit_acess: "ACESSORIOS",
  audit_supl: "SUPLEMENTOS",
  audit_phh: "Peças por Hora",
  audit_rnc_count: "quantidade de RNC GERADAS",
  audit_fotos: "fotos"
};

/* --- FUNÇÕES DE CARREGAMENTO --- */

function gsheetCsvUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}

function fetchCsvAsJson(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results){
        resolve(results.data);
      },
      error: function(err){ reject(err); }
    });
  });
}

/* Helper para limpar números (ex: "30%" -> 30 ou "1.200,50" -> 1200.50) */
const cleanNum = (v) => {
  if(v === undefined || v === null || v === "") return 0;
  if(typeof v === 'number') return v;
  // Remove % e espaços, troca vírgula por ponto
  let s = String(v).replace('%','').replace(/\s/g,'').replace(',','.');
  return Number(s) || 0;
};

/* --- CÁLCULO DE KPIS (ABAS 1, 2, 3) --- */
function computeKpis(auditRows, checkinRows, ncrRows){
  // 1. Auditoria e Categorias
  let totalAuditadas = 0;
  let categoriesAudit = {CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0};
  let phhList = [];
  let rncSum = 0;
  let fotosSum = 0;
  let datas = [];

  auditRows.forEach(r=>{
    totalAuditadas += cleanNum(r[COLMAP.audit_total]);
    categoriesAudit.CALÇADOS += cleanNum(r[COLMAP.audit_cald]);
    categoriesAudit.VESTUARIOS += cleanNum(r[COLMAP.audit_vest]);
    categoriesAudit.ACESSORIOS += cleanNum(r[COLMAP.audit_acess]);
    categoriesAudit.SUPLEMENTOS += cleanNum(r[COLMAP.audit_supl]);
    
    const ph = cleanNum(r[COLMAP.audit_phh]); 
    if(ph > 0) phhList.push(ph);
    
    rncSum += cleanNum(r[COLMAP.audit_rnc_count]);
    fotosSum += cleanNum(r[COLMAP.audit_fotos]);
    
    if(r[COLMAP.audit_date]) datas.push(r[COLMAP.audit_date]);
  });

  // 2. Check-in (Conferidas)
  const checkByDate = {};
  checkinRows.forEach(r => {
    // Tenta pegar a data de várias formas caso mude o cabeçalho
    const d = r["Data"] || r["data"] || r["DATA"] || '';
    if(!d) return;
    
    if(!checkByDate[d]) checkByDate[d] = { total:0, cats:{CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0} };
    
    // Tenta pegar o total conferido
    const totalField = r["CONFERIDAS TOTAL"] ?? r["CONFERIDAS"] ?? r["PCONFERIDAS"] ?? '0';
    checkByDate[d].total += cleanNum(totalField);
    
    // Categorias checkin
    checkByDate[d].cats.CALÇADOS += cleanNum(r["CALÇADOS"] || r["CALÇADO"]);
    checkByDate[d].cats.VESTUARIOS += cleanNum(r["VESTUARIOS"] || r["VESTUARIO"]);
    checkByDate[d].cats.ACESSORIOS += cleanNum(r["ACESSORIOS"] || r["ACESSORIO"]);
    checkByDate[d].cats.SUPLEMENTOS += cleanNum(r["SUPLEMENTOS"] || r["SUPLEMENTO"]);
  });

  // Totais checkin
  let totalConferidas = 0;
  const check_categories = { CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0 };
  Object.values(checkByDate).forEach(v=>{
    totalConferidas += v.total;
    check_categories.CALÇADOS += v.cats.CALÇADOS;
    check_categories.VESTUARIOS += v.cats.VESTUARIOS;
    check_categories.ACESSORIOS += v.cats.ACESSORIOS;
    check_categories.SUPLEMENTOS += v.cats.SUPLEMENTOS;
  });

  // 3. NCR (Não conformes)
  const fornecedores = {};
  const tipos = {};
  let totalAvariados = 0;
  ncrRows.forEach(r=>{
    const qtd = cleanNum(r["QNTD"]);
    const f = r["FORNECEDOR"] || "SEM FORNECEDOR";
    const t = r["TIPO DE AVARIA"] || "OUTRO";
    fornecedores[f] = (fornecedores[f]||0) + qtd;
    tipos[t] = (tipos[t]||0) + qtd;
    totalAvariados += qtd;
  });

  // Taxas
  const taxaNaoConformidade = totalAuditadas>0 ? totalAvariados/totalAuditadas : 0;
  const mediaPhh = phhList.length>0 ? phhList.reduce((a,b)=>a+b,0)/phhList.length : 0;
  const pctAuditadoSobreConferido = totalConferidas>0 ? (totalAuditadas / totalConferidas) : 0;

  return {
    period: {min: datas.length?datas[0]:null, max: datas.length?datas[datas.length-1]:null},
    totalAuditadas, categoriesAudit, mediaPhh,
    totalConferidas, check_categories,
    totalAvariados, taxaNaoConformidade, rncSum, fotosSum,
    fornecedores, tipos, pctAuditadoSobreConferido,
    auditRows, checkinRows // Passando dados brutos para os gráficos diários
  };
}

/* --- RENDERIZAÇÃO TEXTUAL (DOM) --- */
function renderKpis(k){
  document.getElementById('kpi-pecas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('kpi-hh').innerText = k.mediaPhh.toFixed(1);
  document.getElementById('rnc-num').innerText = k.rncSum;
  document.getElementById('fotos-num').innerText = k.fotosSum;
  
  document.getElementById('sum-conferidas').innerText = k.totalConferidas.toLocaleString('pt-BR');
  document.getElementById('sum-auditadas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('pct-auditado').innerText = (k.pctAuditadoSobreConferido*100).toFixed(1)+'%';
  
  document.getElementById('kpi-taxa').innerText = (k.taxaNaoConformidade*100).toFixed(1)+'%';
  document.getElementById('kpi-taxa-qnt').innerText = `${k.totalAvariados} peças`;

  // Lista categorias (Auditoria)
  const catDiv = document.getElementById('categoria-list'); catDiv.innerHTML='';
  ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'].forEach(cat=>{
    const el = document.createElement('div'); el.className='mini-item';
    el.innerHTML = `<div style="font-weight:600">${cat}</div><div>${(k.categoriesAudit[cat]||0).toLocaleString('pt-BR')}</div>`;
    catDiv.appendChild(el);
  });

  // Top 3 Fornecedores
  const fornArr = Object.entries(k.fornecedores || {}).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const fornDiv = document.getElementById('fornecedores-list'); fornDiv.innerHTML='';
  fornArr.forEach((f,i)=>{
    const row = document.createElement('div'); 
    row.style.cssText='display:flex;justify-content:space-between;padding:6px 0';
    row.innerHTML = `<div>${i+1}º - ${f[0]}</div><div style="font-weight:700">${f[1]}</div>`;
    fornDiv.appendChild(row);
  });

  // Top Avarias
  const tiposArr = Object.entries(k.tipos || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const tiposDiv = document.getElementById('tipos-list'); tiposDiv.innerHTML='';
  tiposArr.forEach(t=>{
    const r = document.createElement('div'); 
    r.style.cssText='display:flex;justify-content:space-between;padding:4px 0';
    r.innerHTML = `<div>${t[0]}</div><div>${t[1]}</div>`;
    tiposDiv.appendChild(r);
  });

  // Período
  const pText = (k.period.min && k.period.max) ? `${k.period.min} → ${k.period.max}` : '--';
  document.getElementById('periodo-text').innerText = pText;
  document.getElementById('meta-note').innerText = "Meta mínima de inspeção diária: 25%";
}

/* --- GRÁFICOS DIÁRIOS (CENTRO) --- */
let chartCheckin = null;
let chartCats = null;

function drawCharts(k){
  // Gráfico 1: Barras Conferidas vs Auditadas
  // Agrupa Auditadas por Data
  const auditByDate = {};
  k.auditRows.forEach(r=>{
    const d = r[COLMAP.audit_date] || 'Indef';
    auditByDate[d] = (auditByDate[d] || 0) + cleanNum(r[COLMAP.audit_total]);
  });
  
  // Agrupa Conferidas por Data
  const checkByDate = {};
  k.checkinRows.forEach(r=>{
    const d = r["Data"] || r["data"] || r["DATA"];
    if(d) checkByDate[d] = (checkByDate[d] || 0) + cleanNum(r["CONFERIDAS"] || r["CONFERIDAS TOTAL"]);
  });

  // Une as datas para o eixo X
  const allDates = [...new Set([...Object.keys(auditByDate), ...Object.keys(checkByDate)])].sort();
  
  // Monta datasets
  const dataConf = allDates.map(d => checkByDate[d] || 0);
  const dataAudit = allDates.map(d => auditByDate[d] || 0);
  
  // Desenha Chart 1
  const ctx = document.getElementById('chart-checkin').getContext('2d');
  if(chartCheckin) chartCheckin.destroy();
  chartCheckin = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: allDates,
      datasets: [
        { label:'Conferidas', data: dataConf, backgroundColor:'#1976d2' },
        { label:'Auditadas', data: dataAudit, backgroundColor:'#0b5f3a' }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: function (context) {
              const val = context.parsed.y;
              if (context.dataset.label === 'Auditadas') {
                const conf = dataConf[context.dataIndex];
                const pct = conf > 0 ? ((val / conf) * 100).toFixed(1) : 0;
                return `Auditadas: ${val} (${pct}%)`;
              }
              return `${context.dataset.label}: ${val}`;
            }
          }
        }
      }
    }
  });

  // Gráfico 2: Categorias (Check-in)
  const catLabels = ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'];
  const catData = catLabels.map(c=>k.check_categories[c] || 0);
  
  const ctx2 = document.getElementById('chart-categories').getContext('2d');
  if(chartCats) chartCats.destroy();
  chartCats = new Chart(ctx2, {
    type:'bar',
    data: { 
      labels: catLabels, 
      datasets: [{ label:'Peças', data: catData, backgroundColor:'#8b0000' }] 
    },
    options: { responsive:true, plugins:{legend:{display:false}} }
  });
}

/* --- GRÁFICO HISTÓRICO ANUAL (NOVO) --- */
let chartMonthly = null;

async function drawAnnualChart(historyRows) {
    if(!historyRows || historyRows.length === 0) {
        console.warn("Sem dados para o histórico anual.");
        return;
    }

    // Mapeando colunas da planilha HISTORICO_ANUAL (Baseado no seu print)
    // Colunas esperadas: MES, CONFERIDAS, AUDITADAS, % AUDITADAS, NCONF, % NCONF
    const labels = [];
    const conferidas = [];
    const auditadas = [];
    const pctNconf = [];
    const pctAuditadasTooltip = [];

    historyRows.forEach(r => {
        labels.push(r["MES"] || r["mes"]);
        conferidas.push(cleanNum(r["CONFERIDAS"]));
        auditadas.push(cleanNum(r["AUDITADAS"]));
        pctNconf.push(cleanNum(r["% NCONF"]));
        pctAuditadasTooltip.push(cleanNum(r["% AUDITADAS"]));
    });

    const ctx = document.getElementById("chart-monthly").getContext("2d");
    if (chartMonthly) chartMonthly.destroy();

    chartMonthly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Peças Conferidas",
                    data: conferidas,
                    backgroundColor: "#3e73c3",
                    order: 2,
                    yAxisID: 'y' // Eixo Esquerdo (Quantidades)
                },
                {
                    label: "Peças Auditadas",
                    data: auditadas,
                    backgroundColor: "#8ad05b",
                    order: 3,
                    yAxisID: 'y' // Eixo Esquerdo (Quantidades)
                },
                {
                    label: "% Peças Não Conformes",
                    data: pctNconf,
                    type: "bar", // Pode mudar para 'line' se preferir linha
                    backgroundColor: "#ff0000",
                    borderColor: "#ff0000",
                    borderWidth: 1,
                    order: 1,
                    yAxisID: 'y1', // Eixo Direito (Porcentagem)
                    barPercentage: 0.5 // Barra mais fina
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.dataset.yAxisID === 'y1') {
                                label += context.parsed.y + '%';
                            } else {
                                label += context.parsed.y.toLocaleString('pt-BR');
                                // Adiciona % de auditado no tooltip da barra verde
                                if(context.dataset.label === "Peças Auditadas"){
                                    const pct = pctAuditadasTooltip[context.dataIndex];
                                    label += ` (${pct}%)`;
                                }
                            }
                            return label;
                        }
                    }
                },
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: { display: true, text: 'Quantidade (Peças)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    max: 20, // Ajuste esse máx se a taxa de erro subir muito (ex: 100)
                    grid: {
                        drawOnChartArea: false, // remove grades do eixo secundário para limpar o visual
                    },
                    ticks: {
                        callback: function(value) { return value + "%" }
                    },
                    title: { display: true, text: '% Não Conforme' }
                }
            }
        }
    });
}

/* --- INICIALIZAÇÃO --- */
async function init(){
  try{
    // Carrega dados das 4 abas
    const [auditRows, checkinRows, ncrRows, historyRows] = await Promise.all([
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.audit)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.checkin)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.ncr)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.history))
    ]);

    // Processa Dashboard Diário
    const k = computeKpis(auditRows, checkinRows, ncrRows);
    renderKpis(k);
    drawCharts(k);
    
    // Processa Gráfico Anual
    drawAnnualChart(historyRows);

  } catch(err){
    console.error(err);
    document.body.insertAdjacentHTML('beforeend', `<div style="margin-top:16px;color:#900;background:#fee;padding:10px">Erro ao carregar dados. Verifique se o nome das abas e o ID da planilha estão corretos.<br>Detalhe: ${err.message || err}</div>`);
  }
}

init();
</script>
