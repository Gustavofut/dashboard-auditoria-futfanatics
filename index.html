<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Auditoria — FUTFANATICS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --bg: #ffffff;
      --dark-blue: #052a4a; /* azul escuro da identidade */
      --lime: #a7ff3a;    /* verde limão */
      --muted: #6b7280;
      --card-shadow: 0 6px 18px rgba(7,15,30,0.08);
      --radius: 14px;
      font-family: Inter, system-ui, -apple-system, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--dark-blue)}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;flex-direction:column}
    .brand h1{margin:0;font-size:20px}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:16px}
    .kpi{grid-column: span 3}
    .wide{grid-column: span 6}
    .full{grid-column: 1 / -1}
    .kpi .title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .value{font-size:24px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .chart-wrap{height:260px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #eef2f6}
    th{font-size:12px;color:var(--muted)}
    .supplier-bad{color:#b91c1c;font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--dark-blue);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;border:none}
    .hint{font-size:12px;color:var(--muted)}
    .legend{display:flex;gap:10px;align-items:center}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .sw{width:12px;height:12px;border-radius:3px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--dark-blue),#0b4f8a);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">FF</div>
      <div class="brand">
        <h1>Dashboard Auditoria — FUTFANATICS</h1>
        <p>Visão semanal / mensal de avarias e produtividade</p>
      </div>
      <div style="margin-left:auto" class="controls">
        <div class="hint">Atualiza automaticamente a cada 5 min.</div>
        <button class="btn" id="btn-refresh">Atualizar agora</button>
      </div>
    </header>

    <section class="grid">
      <!-- KPIs -->
      <div class="card kpi" id="kpi-total">
        <div class="title">PEÇAS AUDITADAS (total)</div>
        <div class="value" id="total-audited">—</div>
        <div class="small" id="breakdown-cat">Categorias: —</div>
      </div>

      <div class="card kpi" id="kpi-checked">
        <div class="title">% AUDITADAS CONFERIDAS (Check-in)</div>
        <div class="value" id="pct-checked">—</div>
        <div class="small">(Peças conferidas ÷ Auditas)</div>
      </div>

      <div class="card kpi" id="kpi-defects">
        <div class="title">% PEÇAS COM DEFEITOS</div>
        <div class="value" id="pct-defects">—</div>
        <div class="small">(Defeituosas ÷ Auditadas)</div>
      </div>

      <div class="card kpi" id="kpi-prod">
        <div class="title">PRODUTIVIDADE MÉDIA (peças / h)</div>
        <div class="value" id="prod-avg">—</div>
        <div class="small">(Total peças ÷ total horas registradas)</div>
      </div>

      <!-- Charts -->
      <div class="card wide">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Distribuição por Categoria</div>
          <div class="legend">
            <span><i class="sw" style="background:var(--dark-blue)"></i> Calçados</span>
            <span><i class="sw" style="background:#1f77b4"></i> Vestuário</span>
            <span><i class="sw" style="background:var(--lime)"></i> Acessórios/Suplementos</span>
          </div>
        </div>
        <div class="chart-wrap"><canvas id="catChart"></canvas></div>
      </div>

      <div class="card wide">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Audited vs Checked (%)</div>
          <div class="small">Periodo selecionado: <span id="period">—</span></div>
        </div>
        <div class="chart-wrap"><canvas id="checkChart"></canvas></div>
      </div>

      <!-- Top suppliers table -->
      <div class="card full">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700">Ranking — Top 3 Fornecedores com mais avarias</div>
          <div class="small">Lista dos tipos de avaria mais comuns</div>
        </div>
        <table id="suppliers-table">
          <thead><tr><th>Posição</th><th>Fornecedor</th><th>Peças Avariadas</th><th>Códigos (exemplos)</th><th>Tipos de Avaria (top)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- RNC & OR/NOTAS small -->
      <div class="card kpi">
        <div class="title">Quantidade de OR/NOTAS para RNC (diário)</div>
        <div class="value" id="count-or">—</div>
        <div class="small">(contagem de OR/NOTA marcadas para RNC no período)</div>
      </div>

      <div class="card kpi">
        <div class="title">Quantidade de RNC geradas (acumulado)</div>
        <div class="value" id="count-rnc">—</div>
        <div class="small">(Registros marcados como RNC)</div>
      </div>

      <div class="card wide">
        <div style="font-weight:700;margin-bottom:8px">Tabela de avarias — visual detalhado (filtre por fornecedor)</div>
        <div style="margin-bottom:10px;display:flex;gap:8px">
          <select id="filter-supplier"><option value="">— Todos fornecedores —</option></select>
          <input id="search" placeholder="buscar código / tipo" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8" />
        </div>
        <div style="max-height:320px;overflow:auto">
          <table id="defects-table">
            <thead><tr><th>Data</th><th>Fornecedor</th><th>Código</th><th>Tipo Avaria</th><th>Quantidade</th><th>OR/Nota</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </section>

    <footer style="margin-top:18px;color:var(--muted);font-size:13px">Arquivo: <strong>index.html</strong> • Conecte sua Google Sheet e publique para web (instruções abaixo).</footer>

    <hr style="margin-top:18px" />

    <section style="margin-top:12px">
      <h3>Instruções rápidas de implantação</h3>
      <ol>
        <li>Prepare a Google Sheet com uma aba chamada <code>audits</code> contendo (mínimo) as colunas: <code>date,category,quantity,checked,defect,defect_type,product_code,supplier,order_id,hours_spent,is_rnc</code> (veja explicação dentro do repositório).</li>
        <li>Publique a planilha: Arquivo → Publicar na web → selecionar aba "audits" → publicar. Copie o <strong>Spreadsheet ID</strong> (parte da URL entre <code>/d/</code> e <code>/edit</code>) e o <strong>gid</strong> da aba.</li>
        <li>No topo deste ficheiro (index.html), substitua as constantes <code>SPREADSHEET_ID</code> e <code>SHEET_GID</code> com os valores da sua planilha.</li>
        <li>Faça push do projeto para o GitHub e ative o GitHub Pages nas configurações do repositório (branch main / folder root). O site ficará disponível em <code>https://<your-username>.github.io/<repo-name>/</code>.</li>
      </ol>
    </section>

  </div>

<script>
// ============ CONFIGURAR AQUI === substituir pelos valores da sua planilha ============
const SPREADSHEET_ID = "2PACX-1vSFr79bH0CBz3qUoL9r3tJzv0sSDFzbbmNlKNVyU0n6tzN7H2wxr_EL6Tl4UB7tKxBKZ6jkwIy2W1T6"; // insira o ID da planilha
const SHEET_GID = "0"; // gid da aba audits
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
// =======================================================================================

let rawRows = [];

async function fetchAndRender(){
  if (SPREADSHEET_ID.includes('REPLACE')){
    console.warn('SPREADSHEET_ID não configurado. Edite as constantes no topo do index.html');
    return;
  }
  document.getElementById('btn-refresh').disabled = true;
  try{
    const res = await fetch(CSV_URL);
    const txt = await res.text();
    const parsed = Papa.parse(txt, {header:true,skipEmptyLines:true});
    rawRows = parsed.data.map(r => normalizeRow(r));
    renderAll();
  }catch(e){
    console.error(e);
    alert('Erro ao buscar a planilha. Verifique se ela foi publicada e se IDs estão corretos.');
  }finally{document.getElementById('btn-refresh').disabled = false}
}

function normalizeRow(r){
  // normaliza e converte tipos básicos
  return {
    date: r.date ? new Date(r.date) : null,
    category: (r.category||'').trim(),
    quantity: Number(r.quantity||1),
    checked: (/^(true|1|sim|yes)$/i).test(r.checked||r.checked === true),
    defect: (/^(true|1|sim|yes)$/i).test(r.defect||r.defect === true),
    defect_type: (r.defect_type||'').trim(),
    product_code: (r.product_code||'').trim(),
    supplier: (r.supplier||'').trim(),
    order_id: (r.order_id||'').trim(),
    hours_spent: Number(r.hours_spent||0),
    is_rnc: (/^(true|1|sim|yes)$/i).test(r.is_rnc||r.is_rnc === true)
  }
}

function renderAll(){
  const data = rawRows;
  const totalAudited = data.reduce((s,r)=> s + (r.quantity||0),0);
  document.getElementById('total-audited').innerText = totalAudited.toLocaleString();

  // breakdown por categoria
  const categories = ['Calçados','Vestuarios','Acessorios','Suplementos'];
  const catCounts = {};
  categories.forEach(c=>catCounts[c]=0);
  data.forEach(r=>{
    const key = categories.find(c=> r.category.toLowerCase().includes(c.toLowerCase())) || r.category || 'Outros';
    if (!catCounts[key]) catCounts[key]=0;
    catCounts[key]+= r.quantity || 0;
  });
  const breakdownText = Object.entries(catCounts).map(([k,v])=> `${k}: ${v}`).join(' • ');
  document.getElementById('breakdown-cat').innerText = breakdownText;

  // checked %
  const checkedQty = data.reduce((s,r)=> s + ((r.checked? r.quantity:0) || 0),0);
  const pctChecked = totalAudited? Math.round(checkedQty/totalAudited*100):0;
  document.getElementById('pct-checked').innerText = pctChecked + '%';

  // defects %
  const defectQty = data.reduce((s,r)=> s + ((r.defect? r.quantity:0) || 0),0);
  const pctDef = totalAudited? Math.round(defectQty/totalAudited*100):0;
  document.getElementById('pct-defects').innerText = pctDef + '%';

  // produtividade média
  const totalHours = data.reduce((s,r)=> s + (r.hours_spent||0),0);
  const prodAvg = totalHours? (totalAudited/totalHours).toFixed(2) : '—';
  document.getElementById('prod-avg').innerText = prodAvg;

  // Period text
  const dates = data.map(d=>d.date).filter(Boolean).sort((a,b)=>a-b);
  if (dates.length){
    const p = `${formatDate(dates[0])} → ${formatDate(dates[dates.length-1])}`;
    document.getElementById('period').innerText = p;
  }

  // Categoria chart
  const catLabels = Object.keys(catCounts);
  const catValues = Object.values(catCounts);
  renderPie('catChart', catLabels, catValues);

  // checked chart (audited vs checked)
  renderBar('checkChart', ['Auditadas','Conferidas'], [totalAudited, checkedQty]);

  // ranking fornecedores
  const suppliers = {};
  data.forEach(r=>{
    if (!r.supplier) return;
    if (!suppliers[r.supplier]) suppliers[r.supplier] = {count:0,codes:new Set(),types:{}};
    if (r.defect) suppliers[r.supplier].count += r.quantity||0;
    if (r.product_code) suppliers[r.supplier].codes.add(r.product_code);
    if (r.defect_type){ suppliers[r.supplier].types[r.defect_type] = (suppliers[r.supplier].types[r.defect_type]||0) + (r.quantity||1);} 
  });
  const supArr = Object.entries(suppliers).map(([k,v])=> ({supplier:k,count:v.count,codes:[...v.codes].slice(0,5),types:v.types}));
  supArr.sort((a,b)=> b.count - a.count);
  renderSuppliersTable(supArr.slice(0,3));

  // populate suppliers filter
  const select = document.getElementById('filter-supplier');
  const currentOptions = new Set([...select.querySelectorAll('option')].map(o=>o.value));
  supArr.forEach(s=>{ if (!currentOptions.has(s.supplier)){
    const o=document.createElement('option');o.value=s.supplier;o.textContent=s.supplier;select.appendChild(o);
  } });

  // defects table (detailed list)
  renderDefectsTable(data);

  // RNC / OR counts
  const orCount = data.reduce((s,r)=> s + (r.order_id?1:0),0); // simplificado: contar OR/NOTAS existentes
  document.getElementById('count-or').innerText = orCount;
  const rncCount = data.reduce((s,r)=> s + (r.is_rnc?1:0),0);
  document.getElementById('count-rnc').innerText = rncCount;
}

function renderPie(canvasId, labels, values){
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (window[canvasId]) window[canvasId].destroy();
  window[canvasId] = new Chart(ctx, {
    type:'doughnut',
    data:{labels, datasets:[{data:values,backgroundColor:[getComputedStyle(document.documentElement).getPropertyValue('--dark-blue')||'#052a4a','#1f77b4','#a7ff3a','#8c8c8c']}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });
}

function renderBar(canvasId, labels, values){
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (window[canvasId]) window[canvasId].destroy();
  window[canvasId] = new Chart(ctx, {
    type:'bar',
    data:{labels, datasets:[{label:'Quantidade',data:values,backgroundColor:getBarColors(values.length)}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}

function getBarColors(n){
  const base = getComputedStyle(document.documentElement).getPropertyValue('--dark-blue')||'#052a4a';
  return new Array(n).fill(base);
}

function renderSuppliersTable(list){
  const tbody = document.querySelector('#suppliers-table tbody'); tbody.innerHTML='';
  list.forEach((s,i)=>{
    const tr = document.createElement('tr');
    const typesTop = Object.entries(s.types||{}).sort((a,b)=>b[1]-a[1]).slice(0,3).map(t=>t[0]).join(', ');
    tr.innerHTML = `<td>${i+1}</td><td class="supplier-bad">${s.supplier}</td><td>${s.count}</td><td>${s.codes.join(', ')}</td><td>${typesTop}</td>`;
    tbody.appendChild(tr);
  });
}

function renderDefectsTable(data){
  const tbody = document.querySelector('#defects-table tbody'); tbody.innerHTML='';
  const filter = document.getElementById('filter-supplier').value.toLowerCase();
  const search = document.getElementById('search').value.toLowerCase();
  const rows = data.filter(r=> r.defect).filter(r=> !filter || r.supplier.toLowerCase() === filter).filter(r=> !search || (r.product_code||'').toLowerCase().includes(search) || (r.defect_type||'').toLowerCase().includes(search));
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date?formatDate(r.date):''}</td><td>${r.supplier}</td><td>${r.product_code}</td><td>${r.defect_type}</td><td>${r.quantity}</td><td>${r.order_id||''}</td>`;
    tbody.appendChild(tr);
  });
}

function formatDate(d){ if (!d) return ''; const dd = (`0${d.getDate()}`).slice(-2); const mm = (`0${d.getMonth()+1}`).slice(-2); return `${dd}/${mm}/${d.getFullYear()}` }

// event listeners
document.getElementById('btn-refresh').addEventListener('click', fetchAndRender);
document.getElementById('filter-supplier').addEventListener('change', ()=> renderDefectsTable(rawRows));
document.getElementById('search').addEventListener('input', ()=> renderDefectsTable(rawRows));

// auto refresh every 5 minutes
setInterval(()=>{ fetchAndRender(); }, 1000 * 60 * 5);
// initial
fetchAndRender();
</script>
</body>
</html>

