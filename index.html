<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Auditoria - FUTFANATICS</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #ffffff;
    --blue-dark: #052F5F; /* azul escuro FutFanatics */
    --lime: #b7f24d; /* verde limão */
    --muted: #f3f5f8;
    --text: #0d1b2a;
    --accent: #0b63b7;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{margin:0;background:var(--muted);color:var(--text)}
  header{background:linear-gradient(90deg,var(--blue-dark),#0b4f8f);color:white;padding:18px 24px;display:flex;align-items:center;gap:16px}
  header h1{margin:0;font-size:20px}
  .container{max-width:1200px;margin:22px auto;padding:0 16px;}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .card{background:var(--bg);border-radius:10px;box-shadow:0 6px 18px rgba(9,30,66,.06);padding:14px}
  .card.h-100{display:flex;flex-direction:column;justify-content:space-between;height:100%}
  .kpi{display:flex;gap:12px;align-items:center}
  .kpi .value{font-weight:700;font-size:22px}
  .kpi .label{color:#6b7280;font-size:12px}
  .small{font-size:12px;color:#6b7280}
  /* layout responsive */
  .col-12{grid-column:span 12}
  @media(min-width:700px){
    .col-8{grid-column:span 8}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-3{grid-column:span 3}
  }

  /* bordas e cabeçalhos */
  .card h3{margin:0 0 8px 0;font-size:14px;color:var(--blue-dark)}
  .legend-dot{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px}
  footer{padding:18px 24px;text-align:center;color:#6b7280}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--blue-dark);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .muted-box{background:#fbfdff;padding:8px;border-radius:8px;border:1px solid #edf2f7}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px 8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{font-weight:600;color:#334155}
  .rank-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #eef2f7}
</style>
</head>
<body>
  <header>
    <img src="" id="logo" alt="FUTFANATICS" style="width:46px;height:46px;border-radius:8px;background:var(--lime)" />
    <div>
      <h1>Dashboard Auditoria — Noturno</h1>
      <div style="font-size:12px;color:#cfe6ff">Visão semanal / mensal • Dados: Google Sheets</div>
    </div>
  </header>

  <div class="container">
        <div class="card col-12" style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div class="controls">
          <div class="small">Período (semana de referência):</div>
          <input id="startDate" type="date" />
          <input id="endDate" type="date" />
          <button id="btnUpdate" class="btn">Atualizar</button>
        </div>
        <div class="small">Configuração: ajuste o <code>CONFIG</code> no topo do script se precisar apontar gid/colunas.</div>
      </div>
    </div>

    <div class="grid" style="align-items:stretch">
            <div class="card col-8">
        <h3>Principais KPIs (período selecionado)</h3>
        <div style="display:flex;gap:18px;flex-wrap:wrap">
          <div style="min-width:160px">
            <div class="kpi">
              <div>
                <div class="value" id="kpi_pcs">--</div>
                <div class="label">Peças Auditadas</div>
              </div>
            </div>
          </div>
          <div style="min-width:160px">
            <div class="kpi">
              <div>
                <div class="value" id="kpi_pcs_h">--</div>
                <div class="label">Peças / Hora (média)</div>
              </div>
            </div>
          </div>
          <div style="min-width:160px">
            <div class="kpi">
              <div>
                <div class="value" id="kpi_nconf">--</div>
                <div class="label">Peças Não Conformes</div>
              </div>
            </div>
          </div>
          <div style="min-width:160px">
            <div class="kpi">
              <div>
                <div class="value" id="kpi_pct">--</div>
                <div class="label">Taxa de Não Conformidade (%)</div>
              </div>
            </div>
          </div>
        </div>

        <hr style="margin:12px 0">

        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1" class="card" id="chartAreaCard">
            <canvas id="chart_series" height="160"></canvas>
          </div>

          <div style="width:300px" class="card">
            <h3>Top 3 Fornecedores (avarias)</h3>
            <div id="rankList" style="margin-top:8px"></div>
            <div style="margin-top:8px" class="small">Meta: mínimo 25% por nota | Fornecedores críticos: 40% (configurável)</div>
          </div>
        </div>

      </div>

            <div class="card col-4 h-100">
        <h3>Distribuição por Categoria</h3>
        <canvas id="chart_pie" height="240"></canvas>
        <div style="margin-top:12px">
          <div class="small">Calçados / Vestuário / Acessórios / Suplementos</div>
        </div>
      </div>

            <div class="card col-12">
                <h3>ORs com Não Conformidades (Período)</h3>
        <div style="overflow:auto;max-height:260px">
          <table id="table_nonconf">
                        <thead><tr><th>Data</th><th>Total ORs</th><th>Detalhes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

            <div class="card col-6">
        <h3>Checkin Noturno — por categoria</h3>
        <canvas id="chart_checkin" height="180"></canvas>
      </div>

            <div class="card col-6">
        <h3>Resumo diário (amostra)</h3>
        <div id="dailyTable" style="max-height:260px;overflow:auto"></div>
      </div>

    </div>     <footer>FUTFANATICS • Dashboard Auditoria — gerado localmente no navegador</footer>
  </div> <script>
/*
  CONFIG (edite conforme suas planilhas):
  - SHEET_BASE: URL base da planilha (entre /d/ e /edit)
  - GIDS: gid para cada aba (você encontra no final da URL quando abre a aba)
  - MAPEAMENTO: informe as colunas que contém os campos usados. Use o nome que tiver na sua planilha.
  OBS: O script lê CSVs públicos. Para funcionar, a planilha deve estar "Compartilhada: qualquer pessoa com o link pode visualizar"
*/

const CONFIG = {
  SHEET_ID: '1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0', // OLD: "1nVsXYThcVqLzEiGiEG5QYgZXzn9pVj9S_35nwLW9Qnc"
  GIDS: {
    AUDIT: 0,            // aba que contém médias peças/h (colunas com Data, Peças Auditadas, Qtd. Colaboradoras, Tempo por colaborador, Peças por Hora, NOTAS)
    NONCONF: 306488405,  // aba 'Peças Não Conformes' (defina o gid real)
    CHECKIN: 716543466   // aba com "PEÇAS CHECKIN - NOTURNO" (defina o gid real)
  },
  // Mapeie aqui os headers como estão na sua planilha se forem diferentes.
  MAP: {
    AUDIT: {
      date: 'Data',
      pieces_audited: 'Peças Auditadas (dia)',
      pieces_per_hour: 'Peças por Hora',
      notas: 'NOTAS'
    },
    NONCONF: {
      date: 'Data',
      or: 'OR',
      product: 'Produto',
      supplier: 'Fornecedor',
      category: 'Categoria',
      defect: 'Tipo de Avaria',
      resp: 'Responsável',
      qty: 'Qtd.'
    },
    CHECKIN: {
      header_category_cols: ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'] // nomes das colunas conforme a imagem
    }
  }
};

/* ----------------------
   Helpers: CSV -> JSON
   ---------------------- */
function csvToArray(csv){
  const lines = csv.split(/\r?\n/).filter(l=>l.trim()!=='');
  if(lines.length===0) return [];
  const headers = lines[0].split(',').map(h=>h.replace(/(^"|"$)/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    // split respecting quoted commas
    const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    const clean = parts.map(p=>p.replace(/^"|"$/g,'').trim());
    const obj = {};
    headers.forEach((h,i)=>obj[h]= (clean[i] !== undefined ? clean[i] : ''));
    return obj;
  });
  return rows;
}

/* ----------------------
   Fetch CSV from Google Sheets (export?format=csv&gid=...)
   ---------------------- */
async function fetchSheetCsv(gid){
  const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/export?format=csv&gid=${gid}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Erro ao acessar planilha. Verifique se está pública.');
  const text = await res.text();
  return csvToArray(text);
}

/* ----------------------
   UI and chart building
   ---------------------- */

let chartSeries = null, chartPie = null, chartCheckin = null;

function formatNum(n){
  if(n===null || n===undefined || n==='') return 0;
  const v = Number(String(n).replace(/\./g,'').replace(',','.'));
  return isNaN(v)?0:v;
}

function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

async function updateDashboard(){
  try{
    // desabilita botão
    document.getElementById('btnUpdate').disabled = true;
    document.getElementById('btnUpdate').innerText = 'Carregando...';

    // ler datas da UI
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const dateFrom = start ? new Date(start) : null;
    const dateTo = end ? new Date(end) : null;

    // Função auxiliar de filtragem por data
    const filterByDate = (r, dateField) => {
      if(!r[dateField]) return false;
      // Tenta formato dd/mm/yyyy
      let d = new Date(r[dateField].split('/').reverse().join('-'));
      // Se não for dd/mm/yyyy, tenta outros formatos (e.g., yyyy-mm-dd)
      if(isNaN(d.getTime())) {
        d = new Date(r[dateField]);
      }
      if(isNaN(d.getTime())) return true; // Mantém se a data for inválida mas a linha existir
      // Para comparação de datas (apenas o dia)
      d.setHours(0,0,0,0);
      const from = dateFrom ? new Date(dateFrom.getTime()) : null;
      const to = dateTo ? new Date(dateTo.getTime()) : null;
      if (from) from.setHours(0,0,0,0);
      if (to) to.setHours(23,59,59,999); // Inclui o dia final

      return (!from || d>=from) && (!to || d<=to);
    };


    // 1) AUDIT
    const rawAudit = await fetchSheetCsv(CONFIG.GIDS.AUDIT);
    // tenta detectar colunas mapeadas (use os nomes do MAP)
    const mapA = CONFIG.MAP.AUDIT;
    const auditRows = rawAudit.map(r=>{
      return {
        date: r[mapA.date] || r['Data'] || r['data'] || Object.values(r)[0],
        pieces_audited: formatNum(r[mapA.pieces_audited] || r['Peças Auditadas (dia)'] || r['Peças Auditadas'] || r['Peças Confer']),
        pieces_per_hour: formatNum(r[mapA.pieces_per_hour] || r['Peças por Hora']),
        notas: r[mapA.notas] || r['NOTAS'] || r['Notas']
      };
    }).filter(r=>r.date);

    // filtrar por período se informado
    const filteredAudit = auditRows.filter(r=>filterByDate(r, 'date'));

    // sumarizar daily series
    const labels = filteredAudit.map(r=>r.date);
    const seriesPieces = filteredAudit.map(r=>r.pieces_audited);
    const seriesPph = filteredAudit.map(r=>r.pieces_per_hour);

    // KPIs
    const totalPieces = sum(seriesPieces);
    const avgPph = seriesPph.length? (sum(seriesPph)/seriesPph.length).toFixed(1) : 0;

    // 2) NONCONF
    const rawNon = await fetchSheetCsv(CONFIG.GIDS.NONCONF);
    const mapN = CONFIG.MAP.NONCONF;
    const nonRows = rawNon.map(r=>({
      date: r[mapN.date] || r['Data'],
      or: r[mapN.or] || r['OR'],
      product: r[mapN.product] || r['Produto'],
      supplier: r[mapN.supplier] || r['Fornecedor'],
      category: r[mapN.category] || r['Categoria'],
      defect: r[mapN.defect] || r['Tipo de Avaria'],
      resp: r[mapN.resp] || r['Responsável'],
      qty: formatNum(r[mapN.qty] || r['Qtd.'] || r['Qtd'])
    })).filter(x=>x.date);

    // filtrar período
    const nonFiltered = nonRows.filter(r=>filterByDate(r, 'date'));
    
    // CORREÇÃO: totalNonConf deve somar a coluna Qtd.
    const totalNonConf = sum(nonFiltered.map(x=>x.qty));

    // CORREÇÃO: taxa de não conformidade = totalNonConf / totalPieces * 100
    const pctNon = totalPieces ? ((totalNonConf/totalPieces)*100).toFixed(1) : (0.0).toFixed(1);

    // ranking fornecedores
    const supplierMap = {};
    nonFiltered.forEach(r=>{
      const s = (r.supplier||'N/E').trim();
      // CORREÇÃO: soma por Qtd.
      supplierMap[s] = (supplierMap[s] || 0) + r.qty;
    });
    const ranking = Object.entries(supplierMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
    
    // CORREÇÃO: Preparar dados para Lista - ORs com Não Conformidades
    // Agrupa por OR para contar ORs com fotos processadas (que é o que a tabela parece se referir)
    const orsWithNonConf = {};
    nonFiltered.forEach(r => {
      if(r.or) {
        const key = r.date + '|' + r.or;
        if (!orsWithNonConf[key]) {
          orsWithNonConf[key] = {
            date: r.date,
            or: r.or,
            nonConfCount: 1, // Conta a ocorrência da OR
            categories: new Set([r.category]),
            totalQty: r.qty // Soma a quantidade de itens defeituosos na OR
          };
        } else {
          orsWithNonConf[key].nonConfCount++;
          orsWithNonConf[key].totalQty += r.qty;
          orsWithNonConf[key].categories.add(r.category);
        }
      }
    });
    
    const distinctOrs = Object.values(orsWithNonConf);
    // Ordena por data (inversa para os mais recentes primeiro)
    distinctOrs.sort((a, b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-')));


    // 3) CHECKIN
    const rawCheck = await fetchSheetCsv(CONFIG.GIDS.CHECKIN);
    // espera que existam colunas com nomes indicados em CONFIG.MAP.CHECKIN.header_category_cols
    const checkHeaders = CONFIG.MAP.CHECKIN.header_category_cols;
    let checkSums = {};
    rawCheck.forEach(r=>{
      checkHeaders.forEach(h=>{
        const val = formatNum(r[h] || r[h.toUpperCase()] || r[h.toLowerCase()]);
        checkSums[h] = (checkSums[h] || 0) + val;
      });
    });
    
    // CHARTS + UI render
    // KPIs (usando .toLocaleString('pt-BR') para formatação)
    document.getElementById('kpi_pcs').innerText = totalPieces.toLocaleString('pt-BR');
    document.getElementById('kpi_pcs_h').innerText = Number(avgPph).toLocaleString('pt-BR');
    // CORREÇÃO APLICADA AQUI
    document.getElementById('kpi_nconf').innerText = totalNonConf.toLocaleString('pt-BR');
    document.getElementById('kpi_pct').innerText = pctNon + ' %';

    // CORREÇÃO: tabela ORs com Não Conformes
    const tbody = document.querySelector('#table_nonconf tbody');
    tbody.innerHTML = '';
    
    // Mapeia para exibir somente uma linha por OR com informações consolidadas.
    distinctOrs.slice(0, 120).forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.date||''}</td><td><span style="font-weight:700">${item.or}</span> (${item.totalQty} pçs c/ defeito)</td><td>${Array.from(item.categories).join(', ')}</td>`;
      tbody.appendChild(tr);
    });

    // ranking UI
    const rankList = document.getElementById('rankList');
    rankList.innerHTML = '';
    ranking.slice(0,3).forEach((it, idx)=>{
      const div = document.createElement('div');
      div.className = 'rank-item';
      div.innerHTML = `<div style="font-weight:600">${idx+1}. ${it[0]}</div><div style="font-weight:700">${it[1].toLocaleString('pt-BR')}</div>`;
      rankList.appendChild(div);
    });

    // daily summary table
    const dailyDiv = document.getElementById('dailyTable');
    let html = '<table><thead><tr><th>Data</th><th>Peças</th><th>Peças/H</th><th>Notas</th></tr></thead><tbody>';
    filteredAudit.forEach(r=>{
      html += `<tr><td>${r.date||''}</td><td>${r.pieces_audited.toLocaleString('pt-BR')||0}</td><td>${r.pieces_per_hour.toLocaleString('pt-BR')||0}</td><td>${r.notas||''}</td></tr>`;
    });
    html += '</tbody></table>';
    dailyDiv.innerHTML = html;

    // Charts
    // time series (pieces & pph)
    const ctx = document.getElementById('chart_series').getContext('2d');
    if(chartSeries) chartSeries.destroy();
    chartSeries = new Chart(ctx, {
      type:'bar',
      data:{
        labels: labels,
        datasets:[
          { type:'bar', label:'Peças Auditadas', data: seriesPieces, yAxisID:'y', backgroundColor: 'rgba(11,99,183,0.9)' },
          { type:'line', label:'Peças / Hora', data: seriesPph, yAxisID:'y2', borderColor:'#b7f24d', backgroundColor:'#b7f24d', tension:0.2, pointRadius:3 }
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{ position:'left', title:{display:true,text:'Peças'} },
          y2:{ position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'Peças / Hora'} }
        },
        plugins:{legend:{position:'top'}}
      }
    });

    // CORREÇÃO: pie category (usa nonFiltered - que já está filtrado por data - e soma as quantidades)
    const catMap = {};
    nonFiltered.forEach(r=>{
      // Garante que a categoria não é vazia
      const c = (r.category || 'OUTROS').toString().toUpperCase().trim();
      catMap[c] = (catMap[c] || 0) + (r.qty||0);
    });
    
    const pieLabels = Object.keys(catMap).filter(k=>catMap[k]>0); // Remove categorias com zero
    const pieData = pieLabels.map(k=>catMap[k]);
    
    const ctx2 = document.getElementById('chart_pie').getContext('2d');
    if(chartPie) chartPie.destroy();
    chartPie = new Chart(ctx2, {
      type:'doughnut',
      data:{ 
        labels: pieLabels, 
        datasets:[{
          data: pieData,
          backgroundColor: ['#0b63b7', '#ff6384', '#ffcd56', '#4bc0c0', '#9966ff', '#ff9900'] // Cores padrão (pode adicionar mais)
        }] 
      },
      options:{ 
        plugins:{
          legend:{position:'bottom'}
        } 
      }
    });

    // checkin bar
    const ckLabels = Object.keys(checkSums);
    const ckData = ckLabels.map(k=>checkSums[k]);
    const ctx3 = document.getElementById('chart_checkin').getContext('2d');
    if(chartCheckin) chartCheckin.destroy();
    chartCheckin = new Chart(ctx3, {
      type:'bar',
      data:{ labels: ckLabels, datasets:[{label:'Checkin',data:ckData, backgroundColor:'rgba(5,47,95,0.9)'}] },
      options:{ responsive:true, plugins:{legend:{display:false}} }
    });

  }catch(err){
    alert('Erro ao atualizar dashboard: ' + err.message);
    console.error(err);
  }finally{
    document.getElementById('btnUpdate').disabled = false;
    document.getElementById('btnUpdate').innerText = 'Atualizar';
  }
}

/* ----------------------
   Inicialização: preencher datas e botão
   ---------------------- */
document.getElementById('btnUpdate').addEventListener('click', updateDashboard);
// preenche último mês como padrão
(function setDefaultDates(){
  const today = new Date();
  const prior = new Date(); prior.setDate(today.getDate()-7);
  const dd = d=>String(d.getDate()).padStart(2,'0');
  const mm = d=>String(d.getMonth()+1).padStart(2,'0');
  document.getElementById('startDate').value = `${prior.getFullYear()}-${mm(prior)}-${dd(prior)}`;
  document.getElementById('endDate').value = `${today.getFullYear()}-${mm(today)}-${dd(today)}`;
})();

// Chama o update ao carregar a página
document.addEventListener('DOMContentLoaded', updateDashboard);

</script>
</body>
</html>
