<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Auditoria - FutFanatics</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- PapaParse para CSV do Google Sheets -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --navy: #001C40;       /* azul escuro FutFanatics */
      --accent: #A4FF00;     /* verde-limão */
      --muted: #f5f6f7;
      --card-radius: 12px;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:var(--bg); color:var(--navy); padding:18px;}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px;}
    header h1{margin:0;font-size:20px;color:var(--navy);}
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr 420px;
      gap:18px;
      align-items:start;
    }

    /* Left column (cards) */
    .col-left{display:flex;flex-direction:column;gap:18px;}
    .card{background:#fff;border-radius:var(--card-radius);box-shadow:var(--card-shadow);padding:16px;border:2px solid rgba(0,0,0,0.04);}
    .kpi-large{font-size:48px;font-weight:700;text-align:center;color:var(--navy);}
    .kpi-label{text-align:center;font-size:13px;color:#333;margin-top:6px;}
    .mini-list{display:flex;flex-direction:column;gap:6px;margin-top:6px;}
    .mini-item{display:flex;justify-content:space-between;padding:6px;background:var(--muted);border-radius:8px;font-size:13px}

    /* Center - charts */
    .col-center{display:flex;flex-direction:column;gap:18px;}
    .chart-card{background:#fff;border-radius:var(--card-radius);padding:12px;box-shadow:var(--card-shadow);}
    .chart-row{display:flex;gap:12px;align-items:center;}
    .legend{display:flex;gap:10px;align-items:center;font-size:13px}
    .legend-swatch{width:14px;height:14px;border-radius:3px}
    /* Right column - ranking + tipos */
    .col-right{display:flex;flex-direction:column;gap:18px;}
    .small-title{font-weight:700;color:var(--navy);font-size:13px;margin-bottom:8px}
    footer{margin-top:18px;font-size:12px;color:#666}
    /* responsive */
    @media (max-width:1100px){
      .grid{grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <img src="" alt="Logo" style="width:44px;height:44px;background:var(--navy);border-radius:8px">
    <div>
      <h1>Dashboard Auditoria - FutFanatics</h1>
      <div style="font-size:13px;color:#666">Período: <span id="periodo-text">--</span></div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="col-left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:12px;color:#666">PEÇAS AUDITADAS</div>
            <div class="kpi-large" id="kpi-pecas">--</div>
            <div class="kpi-label">total do período</div>
          </div>
          <div style="width:120px">
            <div style="font-size:12px;color:#666">TAXA DE NÃO CONFORMIDADE</div>
            <div style="font-weight:700;font-size:24px;color:var(--navy)" id="kpi-taxa">--</div>
            <div style="font-size:12px;color:#999" id="kpi-taxa-qnt">--</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="small-title">Distribuição por categoria</div>
          <div class="mini-list" id="categoria-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="small-title">Fornecedores Críticos (top 3)</div>
        <div id="fornecedores-list"></div>
        <div style="margin-top:12px" class="small-title">Tipos de Avaria mais frequentes</div>
        <div id="tipos-list"></div>
      </div>

    </div>

    <!-- CENTER -->
    <div class="col-center">
      <div class="chart-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small-title">Peças Conferidas (Check-in) vs Peças Auditadas</div>
          <div style="display:flex;gap:12px;align-items:center">
            <div class="legend"><div class="legend-swatch" style="background:#1976d2"></div> Conferidas</div>
            <div class="legend"><div class="legend-swatch" style="background:#0b5f3a"></div> Auditadas</div>
            <div class="legend"><div class="legend-swatch" style="background:gold"></div> Média peças H/H</div>
          </div>
        </div>
        <canvas id="chart-checkin" height="150"></canvas>
        <div style="font-size:12px;color:#666;margin-top:8px" id="meta-note"></div>
      </div>

      <div class="chart-card" style="display:flex;gap:12px;align-items:center;">
        <div style="flex:1">
          <div class="small-title">Peças por Categoria (Check-in)</div>
          <canvas id="chart-categories" height="120"></canvas>
        </div>
        <div style="width:220px">
          <div class="small-title">RNC / Fotos (período)</div>
          <div style="font-size:24px;font-weight:700;color:var(--navy)"><span id="rnc-num">--</span> RNC</div>
          <div style="font-size:20px;font-weight:600;color:#444;margin-top:6px"><span id="fotos-num">--</span> Fotos</div>
        </div>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="col-right">
      <div class="card">
        <div class="small-title">Média Peças H/H (média das médias)</div>
        <div style="font-size:36px;font-weight:800;color:var(--navy)" id="kpi-hh">--</div>
        <div style="font-size:13px;color:#666">Média diária das colunas "Peças por Hora"</div>
      </div>

      <div class="card">
        <div class="small-title">Resumo rápido</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;justify-content:space-between"><div>Peças Conferidas</div><div id="sum-conferidas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>Peças Auditadas</div><div id="sum-auditadas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>% Auditado sobre Conferido</div><div id="pct-auditado">--</div></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div>Gerado automaticamente. Para alterar as fontes de dados, atualize o Google Sheets e publique a aba como CSV.</div>
  </footer>

<script>
/*
  CONFIGURE AQUI:
  - Cole o ID da planilha Google (parte entre /d/ e /edit)
  - Se mudar nomes das abas, atualize SHEET_NAMES
  - Atenção para nomes de colunas com espaços extras (ex.: "quantidade de FOTOS ")
*/
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0";
const SHEET_NAMES = {
  audit: "1",
  checkin: "2",
  ncr: "3"
};
/* Se algum cabeçalho tiver variação, mapeie aqui (nomes exatos das colunas no google sheet) */
const COLMAP = {
  audit_date: "Data",
  audit_total: "Peças Auditadas (dia) TOTAL",
  audit_cald: "CALÇADOS",
  audit_vest: "VESTUARIOS",
  audit_acess: "ACESSORIOS",
  audit_supl: "SUPLEMENTOS",
  audit_phh: "Peças por Hora",
  audit_rnc_count: "quantidade de RNC GERADAS",
  audit_fotos: "quantidade de FOTOS "
};

function gsheetCsvUrl(sheetName){
  // Formato: https://docs.google.com/spreadsheets/d/{ID}/gviz/tq?tqx=out:csv&sheet={sheetName}
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}

/* Util: parse CSV via PapaParse returning array of objects */
function fetchCsvAsJson(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results){
        resolve(results.data);
      },
      error: function(err){ reject(err); }
    });
  });
}

/* Calcula KPIs a partir dos arrays de objetos */
function computeKpis(auditRows, checkinRows, ncrRows){
  // auditRows: array com linhas da aba PEÇAS AUDITADAS
  // checkinRows: array (normalmente 1 linha com totais)
  // ncrRows: linhas da aba PEÇAS NÃO CONFORMES

  // 1) total peças auditadas
  let totalAuditadas = 0;
  let categoriesAudit = {CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0};
  let phhList = [];
  let rncSum = 0;
  let fotosSum = 0;
  let datas = [];

  auditRows.forEach(r=>{
    const toNumber = v => { if(v===undefined || v===null || v==="") return 0; return Number(String(v).replace(",",".").replace(/\s/g,'')) || 0; };
    totalAuditadas += toNumber(r[COLMAP.audit_total]);
    categoriesAudit.CALÇADOS += toNumber(r[COLMAP.audit_cald]);
    categoriesAudit.VESTUARIOS += toNumber(r[COLMAP.audit_vest]);
    categoriesAudit.ACESSORIOS += toNumber(r[COLMAP.audit_acess]);
    categoriesAudit.SUPLEMENTOS += toNumber(r[COLMAP.audit_supl]);
    const ph = toNumber(r[COLMAP.audit_phh]); if(ph) phhList.push(ph);
    rncSum += toNumber(r[COLMAP.audit_rnc_count]);
    fotosSum += toNumber(r[COLMAP.audit_fotos]);
    if(r[COLMAP.audit_date]) datas.push(r[COLMAP.audit_date]);
  });

  // checkin totals (espera 1 linha)
  const checkin = checkinRows.length>0 ? checkinRows[0] : {};
  const toNumber = v => { if(v===undefined || v===null || v==="") return 0; return Number(String(v).replace(",",".").replace(/\s/g,'')) || 0; };
  const totalConferidas = toNumber(checkin["CONFERIDAS"] || checkin["PCONFERIDAS".trim()]);
  const check_categories = {
    CALÇADOS: toNumber(checkin["CALÇADOS"]),
    VESTUARIOS: toNumber(checkin["VESTUARIOS"]),
    ACESSORIOS: toNumber(checkin["ACESSORIOS"]),
    SUPLEMENTOS: toNumber(checkin["SUPLEMENTOS"])
  };

  // ncr aggregation
  const fornecedores = {};
  const tipos = {};
  let totalAvariados = 0;
  ncrRows.forEach(r=>{
    const qtd = toNumber(r["QNTD"]);
    const f = r["FORNECEDOR"] || "SEM FORNECEDOR";
    const t = r["TIPO DE AVARIA"] || "OUTRO";
    fornecedores[f] = (fornecedores[f]||0) + qtd;
    tipos[t] = (tipos[t]||0) + qtd;
    totalAvariados += qtd;
  });

  const taxaNaoConformidade = totalAuditadas>0 ? totalAvariados/totalAuditadas : 0;
  const mediaPhh = phhList.length>0 ? phhList.reduce((a,b)=>a+b,0)/phhList.length : 0;
  const pctAuditadoSobreConferido = totalConferidas>0 ? (totalAuditadas / totalConferidas) : 0;

  return {
    period: {min: datas.length?datas[0]:null, max: datas.length?datas[datas.length-1]:null},
    totalAuditadas,
    categoriesAudit,
    mediaPhh,
    totalConferidas,
    check_categories,
    totalAvariados,
    taxaNaoConformidade,
    rncSum,
    fotosSum,
    fornecedores,
    tipos,
    pctAuditadoSobreConferido
  };
}

/* Render UI */
function renderKpis(k){
  document.getElementById('kpi-pecas').innerText = (typeof k.totalAuditadas === 'number') ? k.totalAuditadas.toLocaleString('pt-BR') : k.totalAuditadas;
  document.getElementById('kpi-hh').innerText = k.mediaPhh ? k.mediaPhh.toFixed(1) : '--';
  document.getElementById('rnc-num').innerText = k.rncSum;
  document.getElementById('fotos-num').innerText = k.fotosSum;
  document.getElementById('sum-conferidas').innerText = k.totalConferidas;
  document.getElementById('sum-auditadas').innerText = k.totalAuditadas;
  document.getElementById('pct-auditado').innerText = k.pctAuditadoSobreConferido ? (k.pctAuditadoSobreConferido*100).toFixed(1)+'%' : '--';
  document.getElementById('kpi-taxa').innerText = k.taxaNaoConformidade ? (k.taxaNaoConformidade*100).toFixed(1)+'%' : '--';
  document.getElementById('kpi-taxa-qnt').innerText = k.totalAvariados ? `${k.totalAvariados} peças` : '';
  // categories list
  const catDiv = document.getElementById('categoria-list'); catDiv.innerHTML='';
  ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'].forEach(cat=>{
    const el = document.createElement('div'); el.className='mini-item';
    el.innerHTML = `<div style="font-weight:600">${cat}</div><div>${k.categoriesAudit[cat]||0}</div>`;
    catDiv.appendChild(el);
  });

  // fornecedores top3
  const fornArr = Object.entries(k.fornecedores || {}).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const fornDiv = document.getElementById('fornecedores-list'); fornDiv.innerHTML='';
  fornArr.forEach((f,i)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
    row.innerHTML = `<div>${i+1}º - ${f[0]}</div><div style="font-weight:700">${f[1]}</div>`;
    fornDiv.appendChild(row);
  });

  // tipos de avaria
  const tiposArr = Object.entries(k.tipos || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const tiposDiv = document.getElementById('tipos-list'); tiposDiv.innerHTML='';
  tiposArr.forEach(t=>{
    const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.padding='4px 0';
    r.innerHTML = `<div>${t[0]}</div><div>${t[1]}</div>`;
    tiposDiv.appendChild(r);
  });

  // period
  const pText = (k.period.min && k.period.max) ? `${k.period.min} → ${k.period.max}` : '--';
  document.getElementById('periodo-text').innerText = pText;
  // meta note (show days below 25% inspection goal)
  document.getElementById('meta-note').innerText = `Meta mínima de inspeção diária: 25% - o painel marca percentuais por dia no gráfico.`;
}

/* Desenhar gráficos */
let chartCheckin = null;
let chartCats = null;
function drawCharts(k, auditRows, checkinRows, ncrRows){
  // Chart 1: barras conferidas vs auditadas (aqui assumimos dados por dia — se tiver vários dias no sheet, adapte)
  // Para exemplo simples: usaremos um único ponto (o total). Se tiver vários dias (múltiplas linhas em auditRows), monte arrays por data.
  // Vamos checar se auditRows possuem várias linhas com 'Data' diferentes
  const dates = auditRows.map(r=>r["Data"] || r["data"] || r["DATA"]).filter(Boolean);
  if(dates.length > 1){
    // montar série por data
    const byDate = {};
    auditRows.forEach(r=>{
      const d = (r["Data"]||r["DATA"]||r["data"]) || 'sem-data';
      byDate[d] = byDate[d] || {audit:0, ph:0};
      byDate[d].audit += Number(r[COLMAP.audit_total] || 0);
      byDate[d].ph += Number(r[COLMAP.audit_phh] || 0);
    });
    const labels = Object.keys(byDate);
    const auditData = labels.map(l=>byDate[l].audit);
    const phData = labels.map(l=> (byDate[l].ph) );
    // checkin: if checkinRows contain daily breakdown, adapt; else create single point (total)
    const checkinData = labels.map(()=> Number(k.totalConferidas/labels.length || 0) );
    // draw
    const ctx = document.getElementById('chart-checkin').getContext('2d');
    if(chartCheckin) chartCheckin.destroy();
    chartCheckin = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label:'Conferidas', data: checkinData, backgroundColor:'#1976d2' },
          { label:'Auditadas', data: auditData, backgroundColor:'#0b5f3a' },
          { label:'Média Pçs H/H', data: phData, type:'line', borderColor:'gold', tension:0.3, pointRadius:3 }
        ]
      },
      options: { responsive:true, plugins:{legend:{position:'top'}} }
    });
  } else {
    // single point: mostrar em barras apenas 1 coluna comparativa
    const labels = [ 'Período' ];
    const auditData = [ k.totalAuditadas ];
    const checkData = [ k.totalConferidas ];
    const phData = [ k.mediaPhh ];
    const ctx = document.getElementById('chart-checkin').getContext('2d');
    if(chartCheckin) chartCheckin.destroy();
    chartCheckin = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label:'Conferidas', data: checkData, backgroundColor:'#1976d2' },
          { label:'Auditadas', data: auditData, backgroundColor:'#0b5f3a' },
          { label:'Média Pçs H/H', data: phData, type:'line', borderColor:'gold', tension:0.3, pointRadius:6, yAxisID:'y1' }
        ]
      },
      options: {
        responsive:true,
        scales: {
          y: { beginAtZero:true, position:'left' },
          y1: { beginAtZero:true, position:'right', grid:{display:false} }
        }
      }
    });
  }

  // Chart 2: categorias (checkin)
  const catLabels = ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'];
  const catData = catLabels.map(c=>k.check_categories[c] || 0);
  const ctx2 = document.getElementById('chart-categories').getContext('2d');
  if(chartCats) chartCats.destroy();
  chartCats = new Chart(ctx2, {
    type:'bar',
    data: { labels: catLabels, datasets: [{ label:'Check-in por categoria', data: catData, backgroundColor:'#8b0000' }] },
    options: { responsive:true, plugins:{legend:{display:false}} }
  });

  // marcadores extra: dias com <25% auditado - se tivermos daily data
  // (implementação: se tiver linhas diárias compare auditadas daquele dia contra conferidas totais; aqui deixamos uma nota textual)
}

/* MAIN */
async function init(){
  if(!SHEET_ID || SHEET_ID.includes("COLE_AQUI")){
    document.body.innerHTML = "<div style='padding:40px;font-size:18px;color:#900'>Cole o ID da planilha (SHEET_ID) no código antes de usar. Veja instruções no topo do arquivo.</div>";
    return;
  }

  try{
    const urlAudit = gsheetCsvUrl(SHEET_NAMES.audit);
    const urlCheckin = gsheetCsvUrl(SHEET_NAMES.checkin);
    const urlNcr = gsheetCsvUrl(SHEET_NAMES.ncr);

    const [auditRows, checkinRows, ncrRows] = await Promise.all([
      fetchCsvAsJson(urlAudit),
      fetchCsvAsJson(urlCheckin),
      fetchCsvAsJson(urlNcr)
    ]);

    const k = computeKpis(auditRows, checkinRows, ncrRows);
    renderKpis(k);
    drawCharts(k, auditRows, checkinRows, ncrRows);

  } catch(err){
    console.error(err);
    document.body.insertAdjacentHTML('beforeend', `<div style="margin-top:16px;color:#900">Erro ao carregar dados: ${err.message || err}</div>`);
  }
}

init();
</script>
</body>
</html>

