<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Auditoria - FutFanatics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  :root{
    --azul:#00285E;
    --amarelo:#FFD700;
    --fundo:#f3f6fb;
    --card:#ffffff;
    --texto:#062235;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial; background:var(--fundo); color:var(--texto);}
  .layout{display:flex;min-height:100vh}
  .sidebar{
    width:220px;background:var(--azul);color:#fff;padding:22px;display:flex;flex-direction:column;gap:12px;
  }
  .sidebar h2{margin:0;font-size:20px;letter-spacing:0.3px}
  .content{flex:1;padding:22px 28px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .title{font-size:20px;color:var(--azul);font-weight:700}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,8,35,0.06)}
  .card .label{font-size:13px;color:#6b7280;margin-bottom:6px}
  .card .value{font-size:22px;color:var(--azul);font-weight:700}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,8,35,0.06)}
  .panel h3{margin:0 0 10px 0;color:var(--azul)}
  canvas{width:100% !important;height:320px !important}
  .list-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
  th{background:var(--azul);color:white}
  .badge{background:var(--amarelo);color:var(--azul);padding:4px 8px;border-radius:8px;font-weight:700}
  .muted{color:#64748b;font-size:13px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>FutFanatics</h2>
      <div class="muted">Dashboard de Auditoria</div>
      <nav style="margin-top:14px">
        <div style="margin:8px 0;color:#fff">üè† In√≠cio</div>
        <div style="margin:8px 0;color:#fff">üè≠ Fornecedores</div>
        <div style="margin:8px 0;color:#fff">‚öôÔ∏è N√£o conformidades</div>
        <div style="margin:8px 0;color:#fff">üìä Relat√≥rios</div>
      </nav>
      <div style="margin-top:auto;font-size:12px;opacity:0.9">√öltima leitura: <span id="ultimaLeitura">-</span></div>
    </aside>

    <main class="content">
      <div class="header">
        <div>
          <div class="title">Relat√≥rio Semanal ‚Äî Auditoria & Qualidade</div>
          <div class="muted">FutFanatics ‚Äî</div>
        </div>
        <div>
          <span class="badge" id="top3badge">Top 3 Fornecedores</span>
        </div>
      </div>

      <!-- CARDS -->
      <div class="cards">
        <div class="card"><div class="label">Pe√ßas Auditadas (total)</div><div class="value" id="kpiPecas">-</div>
          <div class="muted" id="kpiPecasBreakdown" style="font-size:13px;margin-top:6px"></div>
        </div>

        <div class="card"><div class="label">P√ß auditadas x conferidas (checkin %)</div><div class="value" id="kpiCheckin">-</div>
          <div class="muted" id="kpiCheckinRaw" style="font-size:13px;margin-top:6px"></div>
        </div>

        <div class="card"><div class="label">Pe√ßas com defeito (total e %)</div><div class="value" id="kpiDef">-</div>
          <div class="muted" id="kpiDefRaw" style="font-size:13px;margin-top:6px"></div>
        </div>

        <div class="card"><div class="label">Produtividade m√©dia (pe√ßas/h)</div><div class="value" id="kpiProd">-</div>
          <div class="muted" id="kpiProdRaw" style="font-size:13px;margin-top:6px"></div>
        </div>

        <div class="card"><div class="label">Fotos p/ RNC (total)</div><div class="value" id="kpiFotos">-</div>
          <div class="muted" style="font-size:13px;margin-top:6px">Fotos enviadas p/ RNC</div>
        </div>

        <div class="card"><div class="label">RNCs geradas (total)</div><div class="value" id="kpiRNCs">-</div>
          <div class="muted" style="font-size:13px;margin-top:6px">Registros com RNC</div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Evolu√ß√£o ‚Äî Pe√ßas Auditadas</h3>
          <canvas id="chartLinha"></canvas>

          <div style="display:flex;gap:12px;margin-top:18px">
            <div style="flex:1">
              <h3 style="margin-bottom:8px">Top Fornecedores (Avarias)</h3>
              <canvas id="chartBar"></canvas>
            </div>
            <div style="width:320px">
              <h3 style="margin-bottom:8px">Tipos de Avaria</h3>
              <canvas id="chartDonut"></canvas>

              <h3 style="margin-top:12px">Fornecedores Cr√≠ticos (Top 3)</h3>
              <div id="rankFor" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <aside class="panel">
          <h3>Resumo r√°pido ‚Äî Categorias</h3>
          <div id="catList"></div>

          <h3 style="margin-top:12px">Respons√°veis (mais ocorr√™ncias)</h3>
          <div id="quickList"></div>
        </aside>
      </div>

    </main>
  </div>

<script>
/* ======== CONFIGURE AQUI ========
 Cole os links CSV p√∫blicos gerados ao publicar cada aba no Google Sheets
 Ex.: "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv"
=================================*/
const URL_AUDIT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFr79bH0CBz3qUoL9r3tJzv0sSDFzbbmNlKNVyU0n6tzN7H2wxr_EL6Tl4UB7tKxBKZ6jkwIy2W1T6/pub?gid=0&single=true&output=csv";
const URL_AVARIAS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFr79bH0CBz3qUoL9r3tJzv0sSDFzbbmNlKNVyU0n6tzN7H2wxr_EL6Tl4UB7tKxBKZ6jkwIy2W1T6/pub?gid=2019792071&single=true&output=csv";
/* ================================ */

function parseNumber(v){ if(v===undefined||v===null||v==="") return 0; v = v.toString().trim().replace(",","."); return isNaN(parseFloat(v))?0:parseFloat(v); }
function parseDateStr(s){
  if(!s) return null;
  s = s.trim();
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
    const p = s.split("/");
    return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
  }
  const d = new Date(s);
  if(!isNaN(d)) return d;
  return null;
}
function formatDate(d){ if(!d) return "-"; const dd = String(d.getDate()).padStart(2,"0"); const mm = String(d.getMonth()+1).padStart(2,"0"); const yyyy = d.getFullYear(); return dd + "/" + mm + "/" + yyyy; }

async function fetchCsv(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("Erro ao carregar CSV: " + url);
  const text = await r.text();
  return text.split(/\r?\n/).filter(l=>l.trim()!=="");
}

async function main(){
  try{
    if(!URL_AUDIT_CSV || !URL_AVARIAS_CSV || URL_AUDIT_CSV.indexOf("http")!==0 || URL_AVARIAS_CSV.indexOf("http")!==0){
      alert("Cole os dois URLs CSV nas constantes no topo do arquivo (URL_AUDIT_CSV e URL_AVARIAS_CSV).");
      return;
    }

    // carregar ambos
    const [audLines, avLines] = await Promise.all([fetchCsv(URL_AUDIT_CSV), fetchCsv(URL_AVARIAS_CSV)]);
    const audHeader = audLines[0].split(",").map(h=>h.trim());
    const avHeader = avLines[0].split(",").map(h=>h.trim());

    // mapear √≠ndices (Auditorias)
    const idxAud = colName => audHeader.indexOf(colName);
    const iData = idxAud("Data"), iPecas = idxAud("PecasAuditadas_dia"), iQtd = idxAud("QtdColaboradoras"), iTempo = idxAud("TempoPorColab_min"), iPecasHora = idxAud("PecasPorHora"),
          iCalc = idxAud("Pecas_Calcados"), iVest = idxAud("Pecas_Vestuario"), iAces = idxAud("Pecas_Acessorios"), iSupp = idxAud("Pecas_Suplementos"), iCheck = idxAud("PecasCheckin");

    // validar
    if(iData===-1 || iPecas===-1 || iCalc===-1 || iVest===-1 || iAces===-1 || iSupp===-1){
      alert("Verifique o cabe√ßalho da aba 'Auditorias'. Cabe√ßalhos necess√°rios: Data, PecasAuditadas_dia, Pecas_Calcados, Pecas_Vestuario, Pecas_Acessorios, Pecas_Suplementos, PecasCheckin.");
      return;
    }

    // mapear indices (Avarias_Detalhes)
    const idxAv = colName => avHeader.indexOf(colName);
    const aData = idxAv("Data"), aOR = idxAv("OR"), aFor = idxAv("Fornecedor"), aProd = idxAv("Produto"), aCod = idxAv("Codigo"),
          aTipo = idxAv("TipoAvaria"), aQntd = idxAv("Qntd"), aFotos = idxAv("FotosRNC"), aRNC = idxAv("RNC_Gerada");

    if(aData===-1 || aFor===-1 || aQntd===-1 || aTipo===-1){
      alert("Verifique o cabe√ßalho da aba 'Avarias_Detalhes'. Cabe√ßalhos necess√°rios: Data, Fornecedor, Qntd, TipoAvaria, FotosRNC, RNC_Gerada.");
      return;
    }

    // parse auditorias
    const audRows = audLines.slice(1).map(r=>r.split(",").map(c=>c.trim()));
    let totalPecas = 0, totalCheckin = 0, totalHorasMin = 0;
    let somaPecasHoraExplict = 0, contPecasHoraExplict = 0;
    const categoriaSoma = {Calcados:0, Vestuario:0, Acessorios:0, Suplementos:0};
    const porDia = {};

    audRows.forEach(cols=>{
      const sData = cols[iData] || "";
      const d = parseDateStr(sData);
      const pecas = parseNumber(cols[iPecas]);
      const check = parseNumber(cols[iCheck]);
      const qtdCol = parseNumber(cols[iQtd]);
      const tempoCol = parseNumber(cols[iTempo]);
      const ph = parseNumber(cols[iPecasHora]);

      const pc = parseNumber(cols[iCalc]), pv = parseNumber(cols[iVest]), pa = parseNumber(cols[iAces]), ps = parseNumber(cols[iSupp]);

      totalPecas += pecas;
      totalCheckin += check;
      if(ph > 0){ somaPecasHoraExplict += ph; contPecasHoraExplict++; }

      // hours minutes for productivity
      if(qtdCol>0 && tempoCol>0) totalHorasMin += (qtdCol * tempoCol);

      categoriaSoma.Calcados += pc;
      categoriaSoma.Vestuario += pv;
      categoriaSoma.Acessorios += pa;
      categoriaSoma.Suplementos += ps
