<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Auditoria - FutFanatics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  :root{
    --azul:#00285E;
    --amarelo:#FFD700;
    --fundo:#f3f6fb;
    --card:#ffffff;
    --texto:#062235;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial; background:var(--fundo); color:var(--texto);}
  .layout{display:flex;min-height:100vh}
  .sidebar{
    width:220px;background:var(--azul);color:#fff;padding:22px;display:flex;flex-direction:column;gap:12px;
  }
  .sidebar h2{margin:0;font-size:20px;letter-spacing:0.3px}
  .sidebar small{opacity:0.85}
  .content{flex:1;padding:22px 28px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .title{font-size:20px;color:var(--azul);font-weight:700}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,8,35,0.06)}
  .card .label{font-size:13px;color:#6b7280;margin-bottom:6px}
  .card .value{font-size:22px;color:var(--azul);font-weight:700}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,8,35,0.06)}
  .panel h3{margin:0 0 10px 0;color:var(--azul)}
  canvas{width:100% !important;height:320px !important}
  .list-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
  th{background:var(--azul);color:white}
  .badge{background:var(--amarelo);color:var(--azul);padding:4px 8px;border-radius:8px;font-weight:700}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>FutFanatics</h2>
      <small>Dashboard de Auditoria</small>
      <nav style="margin-top:14px">
        <div style="margin:8px 0;color:#fff">üè† In√≠cio</div>
        <div style="margin:8px 0;color:#fff">üè≠ Fornecedores</div>
        <div style="margin:8px 0;color:#fff">‚öôÔ∏è N√£o conformidades</div>
        <div style="margin:8px 0;color:#fff">üìä Relat√≥rios</div>
      </nav>
      <div style="margin-top:auto;font-size:12px;opacity:0.85">√öltima leitura: <span id="ultimaLeitura">-</span></div>
    </aside>

    <main class="content">
      <div class="header">
        <div>
          <div class="title">Relat√≥rio Semanal ‚Äî Auditoria & Qualidade</div>
          <div style="color:#64748b;font-size:13px">Visual FutFanatics ‚Äî Autom√°tico via Google Sheets</div>
        </div>
        <div>
          <span class="badge" id="top3badge">Top 3 Fornecedores</span>
        </div>
      </div>

      <!-- CARDS -->
      <div class="cards">
        <div class="card"><div class="label">Pe√ßas Auditadas (total)</div><div class="value" id="kpiPecas">-</div></div>
        <div class="card"><div class="label">Produtividade m√©dia (pe√ßas/h)</div><div class="value" id="kpiProd">-</div></div>
        <div class="card"><div class="label">% Conformidade</div><div class="value" id="kpiConf">-</div></div>
        <div class="card"><div class="label">Total N√£o Conformidades</div><div class="value" id="kpiNC">-</div></div>
        <div class="card"><div class="label">Fornecedores Auditados</div><div class="value" id="kpiForCount">-</div></div>
        <div class="card"><div class="label">√öltima Atualiza√ß√£o</div><div class="value" id="kpiUltima">-</div></div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Evolu√ß√£o di√°ria ‚Äî Pe√ßas Auditadas</h3>
          <canvas id="chartLinha"></canvas>

          <div style="display:flex;gap:12px;margin-top:18px">
            <div style="flex:1">
              <h3 style="margin-bottom:8px">Top 5 Fornecedores (Avarias)</h3>
              <canvas id="chartBar"></canvas>
            </div>
            <div style="width:320px">
              <h3 style="margin-bottom:8px">Tipos de Avaria</h3>
              <canvas id="chartDonut"></canvas>

              <h3 style="margin-top:12px">Fornecedores Cr√≠ticos (Top 3)</h3>
              <div id="rankFor" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <aside class="panel">
          <h3>Resumo r√°pido ‚Äî √öltimo dia</h3>
          <div id="quickList"></div>

          <h3 style="margin-top:12px">Resumo por Categoria</h3>
          <div id="catList"></div>
        </aside>
      </div>

      <div class="panel" style="margin-top:16px">
        <h3>Dados do Dia (√∫ltima data)</h3>
        <table id="tabelaDia">
          <thead><tr><th>Data</th><th>Fornecedor</th><th>Produto</th><th>Tipo Avaria</th><th>Respons√°vel</th><th>Qntd</th><th>NC_dia</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

<script>
/* ********** CONFIGURE AQUI: cole o link CSV publicado do Google Sheets ********** */
const sheetUrl = "COLE_AQUI_SEU_LINK_CSV";
/* **************************************************************************** */

/* Util helpers */
function parseNumber(v){ if(v===undefined||v===null||v==="") return 0; v = v.toString().trim().replace(",","."); return isNaN(parseFloat(v))?0:parseFloat(v); }
function parseDateStr(s){
  if(!s) return null;
  s = s.trim();
  // tenta dd/mm/yyyy
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
    const p = s.split("/");
    return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
  }
  // tenta ISO
  const d = new Date(s);
  if(!isNaN(d)) return d;
  return null;
}
function formatDate(d){
  if(!d) return "-"; const dd = String(d.getDate()).padStart(2,"0"); const mm = String(d.getMonth()+1).padStart(2,"0"); const yyyy = d.getFullYear(); return dd + "/" + mm + "/" + yyyy;
}

/* Main */
async function carregarEDesenhar(){
  try{
    const res = await fetch(sheetUrl);
    if(!res.ok) throw new Error("Falha ao carregar a planilha. Verifique o link CSV.");
    const csv = await res.text();
    const linhas = csv.split(/\r?\n/).filter(r=>r.trim() !== "");
    if(linhas.length < 2) { alert("Planilha vazia ou sem registros."); return; }

    // cabe√ßalho
    const header = linhas[0].split(",").map(h=>h.trim());
    // mapeia √≠ndices conforme os nomes que pedimos
    function idx(colName){
      const i = header.indexOf(colName);
      return i;
    }
    const idxs = {
      Data: idx("Data"),
      PecasAuditadas_dia: idx("PecasAuditadas_dia"),
      QtdColaboradoras: idx("QtdColaboradoras"),
      TempoPorColab_min: idx("TempoPorColab_min"),
      PecasPorHora: idx("PecasPorHora"),
      OR: idx("OR"),
      Produto: idx("Produto"),
      Fornecedor: idx("Fornecedor"),
      Categoria: idx("Categoria"),
      TipoAvaria: idx("TipoAvaria"),
      Responsavel: idx("Responsavel"),
      Marca: idx("Marca"),
      Qntd: idx("Qntd"),
      PecasConfer: idx("PecasConfer"),
      PecasCheckin: idx("PecasCheckin"),
      NC_dia: idx("NC_dia"),
      PercentualAuditada: idx("PercentualAuditada")
    };

    // validar colunas m√≠nimas
    if(idxs.Data === -1 || (idxs.PecasAuditadas_dia === -1 && idxs.PecasPorHora === -1) || idxs.Fornecedor === -1){
      alert("Colunas obrigat√≥rias n√£o encontradas. Verifique se a planilha possui estes cabe√ßalhos: Data, PecasAuditadas_dia (ou PecasPorHora), Fornecedor, Qntd, NC_dia.");
      return;
    }

    const rows = [];
    for(let i=1;i<linhas.length;i++){
      const cols = linhas[i].split(",").map(c=>c.trim());
      rows.push(cols);
    }

    // agregadores
    let totalPecas = 0, somaPecasPorHora = 0, contPecasPorHora = 0, totalNC = 0;
    const mapaForne = {}, mapaTipo = {}, mapaCat = {}, mapaResp = {};
    const porDia = {}; // key yyyy-mm-dd -> total pe√ßas auditadas (PecasAuditadas_dia)
    let latestDate = null;
    let latestDateKey = null;

    rows.forEach(cols=>{
      const sData = cols[idxs.Data] || "";
      const d = parseDateStr(sData);
      if(d){
        const key = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
        if(!porDia[key]) porDia[key] = {pecas:0};
      }
      const pecas = parseNumber(cols[idxs.PecasAuditadas_dia] || cols[idxs.PecasPorHora] || 0);
      const pHora = parseNumber(cols[idxs.PecasPorHora] || 0);
      const qntd = parseNumber(cols[idxs.Qntd] || 0);
      const nc = parseNumber(cols[idxs.NC_dia] || 0);
      const forn = (cols[idxs.Fornecedor]||"").toString();
      const tipo = (cols[idxs.TipoAvaria]||"").toString();
      const cat = (cols[idxs.Categoria]||"").toString();
      const resp = (cols[idxs.Responsavel]||"").toString();

      totalPecas += pecas;
      if(pHora > 0){ somaPecasPorHora += pHora; contPecasPorHora++; }
      totalNC += nc;

      if(forn){
        mapaForne[forn] = (mapaForne[forn] || 0) + qntd;
      }
      if(tipo){
        mapaTipo[tipo] = (mapaTipo[tipo] || 0) + nc;
      }
      if(cat){
        mapaCat[cat] = (mapaCat[cat] || 0) + qntd;
      }
      if(resp){
        mapaResp[resp] = (mapaResp[resp] || 0) + (qntd + nc);
      }

      if(d){
        const key = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
        porDia[key].pecas = (porDia[key].pecas || 0) + pecas;
      }

      // track latest date
      if(d && (!latestDate || d > latestDate)){ latestDate = d; latestDateKey = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"); }
    });

    // KPIs
    const prodMedia = contPecasPorHora ? (somaPecasPorHora / contPecasPorHora) : 0;
    const percConform = totalPecas ? Math.max(0, (1 - (totalNC / totalPecas)) * 100) : 100;
    const fornecedoresAuditados = Object.keys(mapaForne).length;

    // preencher cards
    document.getElementById("kpiPecas").innerText = totalPecas.toLocaleString();
    document.getElementById("kpiProd").innerText = prodMedia.toFixed(1);
    document.getElementById("kpiConf").innerText = percConform.toFixed(1) + " %";
    document.getElementById("kpiNC").innerText = totalNC.toLocaleString();
    document.getElementById("kpiForCount").innerText = fornecedoresAuditados;
    document.getElementById("kpiUltima").innerText = latestDate ? formatDate(latestDate) : "-";
    document.getElementById("ultimaLeitura").innerText = new Date().toLocaleString();

    // preparar dados para gr√°ficos
    // Linha: porDia ordenado por data
    const diasKeys = Object.keys(porDia).sort();
    const diasLabels = diasKeys.map(k => {
      const parts = k.split("-");
      return parts[2]+"/"+parts[1] + "/" + parts[0]; // dd/mm/yyyy
    });
    const diasValues = diasKeys.map(k => porDia[k].pecas || 0);

    // Top fornecedores (ordenar)
    const arrFor = Object.entries(mapaForne).sort((a,b)=>b[1]-a[1]);
    const top5For = arrFor.slice(0,5);
    const labelsFor = top5For.map(x=>x[0]); const valsFor = top5For.map(x=>x[1]);

    // tipos
    const arrTipo = Object.entries(mapaTipo).sort((a,b)=>b[1]-a[1]);
    const labelsTipo = arrTipo.map(x=>x[0]); const valsTipo = arrTipo.map(x=>x[1]);

    // categorias resumo
    const arrCat = Object.entries(mapaCat).sort((a,b)=>b[1]-a[1]);
    const catDiv = document.getElementById("catList");
    catDiv.innerHTML = arrCat.slice(0,10).map(x=>`<div class="list-item"><div>${x[0]}</div><div style="font-weight:700">${x[1]}</div></div>`).join("");

    // quick list (top responsaveis)
    const arrResp = Object.entries(mapaResp).sort((a,b)=>b[1]-a[1]);
    const quickDiv = document.getElementById("quickList");
    quickDiv.innerHTML = arrResp.slice(0,6).map(x=>`<div class="list-item"><div>${x[0]}</div><div>${x[1]}</div></div>`).join("");

    // ranking top 3 fornecedores cr√≠ticos (por Qntd)
    const top3 = arrFor.slice(0,3);
    const rankDiv = document.getElementById("rankFor");
    rankDiv.innerHTML = top3.map((x,i)=>`<div style="padding:8px 0"><strong>${i+1}. ${x[0]}</strong> ‚Äî ${x[1]} pe√ßas</div>`).join("");

    // preencher badge top3
    if(top3.length>0) document.getElementById("top3badge").innerText = `Top 3: ${top3.map(x=>x[0]).join(" ‚Ä¢ ")}`;

    // tabela do dia (linhas com latestDate)
    const tbody = document.querySelector("#tabelaDia tbody");
    tbody.innerHTML = "";
    rows.forEach(cols=>{
      const sData = cols[idxs.Data];
      const d = parseDateStr(sData);
      if(!d || !latestDate) return;
      if(d.getFullYear() === latestDate.getFullYear() && d.getMonth() === latestDate.getMonth() && d.getDate() === latestDate.getDate()){
        const forn = cols[idxs.Fornecedor]||"";
        const prod = cols[idxs.Produto]||"";
        const tipo = cols[idxs.TipoAvaria]||"";
        const resp = cols[idxs.Responsavel]||"";
        const qnt = cols[idxs.Qntd]||"0";
        const nc = cols[idxs.NC_dia]||"0";
        const rowHtml = `<tr><td>${formatDate(d)}</td><td>${forn}</td><td>${prod}</td><td>${tipo}</td><td>${resp}</td><td>${qnt}</td><td>${nc}</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", rowHtml);
      }
    });

    // Charts (Chart.js)
    // Linha
    const ctxL = document.getElementById("chartLinha").getContext("2d");
    new Chart(ctxL, {
      type: 'line',
      data: { labels: diasLabels, datasets: [{ label: 'Pe√ßas Auditadas', data: diasValues, borderColor: 'var(--azul)', backgroundColor: 'rgba(0,40,94,0.08)', fill:true, tension:0.3, pointRadius:3 }]},
      options: { responsive:true, plugins:{legend:{display:false}}}
    });

    // Bar - top fornecedores
    const ctxB = document.getElementById("chartBar").getContext("2d");
    new Chart(ctxB, {
      type:'bar',
      data:{ labels: labelsFor, datasets:[{ label:'Avarias (qntd)', data: valsFor, backgroundColor: 'var(--amarelo)'}]},
      options:{ indexAxis:'y', responsive:true, plugins:{legend:{display:false}}}
    });

    // Donut - tipos
    const ctxD = document.getElementById("chartDonut").getContext("2d");
    new Chart(ctxD, {
      type:'doughnut',
      data:{ labels: labelsTipo, datasets:[{ data: valsTipo, backgroundColor: ['#FFD700','#FFB84D','#FF8A00','#FF5C00','#FF0000'] }]},
      options:{ responsive:true, plugins:{legend:{position:'right'}}}
    });

  }catch(err){
    console.error(err);
    alert("Erro: " + err.message);
  }
}

/* run */
if(sheetUrl && sheetUrl.indexOf("http")===0){
  carregarEDesenhar();
}else{
  alert("Cole o link CSV do Google Sheets na constante sheetUrl no topo do arquivo.");
}
</script>
</body>
</html>
