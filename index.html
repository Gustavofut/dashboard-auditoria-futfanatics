<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Auditoria - FutFanatics</title>

<!-- Chart.js + PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --azul:#00285E;
    --amarelo:#FFD700;
    --fundo:#f3f6fb;
    --card:#ffffff;
    --texto:#062235;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial; background:var(--fundo); color:var(--texto);}
  .layout{display:flex;min-height:100vh}
  .sidebar{
    width:220px;background:var(--azul);color:#fff;padding:22px;display:flex;flex-direction:column;gap:12px;
  }
  .sidebar h2{margin:0;font-size:20px;letter-spacing:0.3px}
  .content{flex:1;padding:22px 28px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .title{font-size:20px;color:var(--azul);font-weight:700}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,8,35,0.06)}
  .card .label{font-size:13px;color:#6b7280;margin-bottom:6px}
  .card .value{font-size:22px;color:var(--azul);font-weight:700}
  .small{font-size:12px;color:#64748b}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,8,35,0.06)}
  canvas{width:100% !important;height:320px !important}
  .list-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
  th{background:var(--azul);color:white}
  .badge{background:var(--amarelo);color:var(--azul);padding:4px 8px;border-radius:8px;font-weight:700}
  .kpi-breakdown{display:flex;gap:8px;flex-wrap:wrap}
  .kpi-mini{background:#f8fafc;padding:8px;border-radius:8px;font-size:13px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>FutFanatics</h2>
      <div class="small">Dashboard de Auditoria</div>
      <nav style="margin-top:14px">
        <div style="margin:8px 0;color:#fff">üè† In√≠cio</div>
        <div style="margin:8px 0;color:#fff">üè≠ Fornecedores</div>
        <div style="margin:8px 0;color:#fff">‚öôÔ∏è N√£o conformidades</div>
        <div style="margin:8px 0;color:#fff">üìä Relat√≥rios</div>
      </nav>
      <div style="margin-top:auto;font-size:12px;opacity:0.95">√öltima leitura: <span id="ultimaLeitura">-</span></div>
    </aside>

    <main class="content">
      <div class="header">
        <div>
          <div class="title">Relat√≥rio Semanal ‚Äî Auditoria & Qualidade</div>
          <div style="color:#64748b;font-size:13px">Visual FutFanatics ‚Äî Autom√°tico via Google Sheets</div>
        </div>
        <div>
          <span class="badge" id="top3badge">Top 3 Fornecedores</span>
        </div>
      </div>

      <!-- CARDS -->
      <div class="cards">
        <div class="card">
          <div class="label">Pe√ßas Auditadas (total)</div>
          <div class="value" id="kpiPecas">-</div>
          <div class="kpi-breakdown small" id="kpiCategorias"></div>
        </div>

        <div class="card">
          <div class="label">Auditado vs Check-in (%)</div>
          <div class="value" id="kpiCheckPct">-</div>
          <div class="small">Auditadas: <span id="kpiCheckA">-</span> | Check-in: <span id="kpiCheckB">-</span></div>
        </div>

        <div class="card">
          <div class="label">Pe√ßas com defeitos (total / %)</div>
          <div class="value" id="kpiDefTotal">-</div>
          <div class="small">Percentual sobre auditado: <span id="kpiDefPct">-</span></div>
        </div>

        <div class="card">
          <div class="label">Produtividade m√©dia (pe√ßas/h)</div>
          <div class="value" id="kpiProd">-</div>
        </div>

        <div class="card">
          <div class="label">Fotos RNC (total)</div>
          <div class="value" id="kpiFotos">-</div>
        </div>

        <div class="card">
          <div class="label">RNCs geradas (total)</div>
          <div class="value" id="kpiRNC">-</div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Evolu√ß√£o di√°ria ‚Äî Pe√ßas Auditadas</h3>
          <canvas id="chartLinha"></canvas>

          <div style="display:flex;gap:12px;margin-top:18px">
            <div style="flex:1">
              <h3 style="margin-bottom:8px">Top Fornecedores (Avarias)</h3>
              <canvas id="chartBar"></canvas>
            </div>
            <div style="width:320px">
              <h3 style="margin-bottom:8px">Tipos de Avaria</h3>
              <canvas id="chartDonut"></canvas>

              <h3 style="margin-top:12px">Fornecedores Cr√≠ticos (Top 3)</h3>
              <div id="rankFor" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <aside class="panel">
          <h3>Resumo r√°pido ‚Äî Categorias</h3>
          <div id="catList"></div>

          <h3 style="margin-top:12px">Respons√°veis (mais registros)</h3>
          <div id="respList"></div>
        </aside>
      </div>

      <div class="panel" style="margin-top:16px">
        <h3>Registros de Defeitos (tabela resumida)</h3>
        <table id="tabelaDef">
          <thead><tr><th>Data</th><th>OR</th><th>Fornecedor</th><th>Produto</th><th>C√≥digo</th><th>Tipo</th><th>Qntd</th><th>Photos</th><th>RNC</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

    </main>
  </div>

<script>
/* ===================== CONFIGURE AQUI ===================== */
/* Cole os links CSV que voc√™ criou (arquivo "Publicar na Web") */
const sheetUrlResumo = "COLE_AQUI_LINK_CSV_RESUMO";
const sheetUrlDefeitos = "COLE_AQUI_LINK_CSV_DEFEITOS";
/* ========================================================= */

if(!sheetUrlResumo || !sheetUrlResumo.startsWith("http") || !sheetUrlDefeitos || !sheetUrlDefeitos.startsWith("http")){
  alert("Cole os links CSV nas constantes sheetUrlResumo e sheetUrlDefeitos no topo do arquivo.");
}

/* ---------- Helpers ---------- */
function parseNumber(v){ if(v===undefined||v===null||v==="") return 0; v = v.toString().trim().replace(",","."); return isNaN(parseFloat(v))?0:parseFloat(v); }
function parseDateStr(s){
  if(!s) return null;
  s = s.toString().trim();
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
    const p = s.split("/");
    return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
  }
  const d = new Date(s);
  return isNaN(d)?null:d;
}
function formatDate(d){
  if(!d) return "-"; const dd = String(d.getDate()).padStart(2,"0"); const mm = String(d.getMonth()+1).padStart(2,"0"); const yyyy = d.getFullYear(); return dd + "/" + mm + "/" + yyyy;
}

/* ---------- Main ---------- */
async function carregarEDesenhar(){
  try{
    // carregar ambos CSVs com PapaParse (funciona com CORS do Google pub?output=csv)
    const [resResumo, resDef] = await Promise.all([
      fetch(sheetUrlResumo).then(r=>r.text()),
      fetch(sheetUrlDefeitos).then(r=>r.text())
    ]);
    const parseResumo = Papa.parse(resResumo, {header:true, skipEmptyLines:true});
    const parseDef = Papa.parse(resDef, {header:true, skipEmptyLines:true});
    const rowsResumo = parseResumo.data;
    const rowsDef = parseDef.data;

    // normalizar nomes de coluna em ambos (trim)
    function normRow(r){ const o={}; for(const k in r){ if(typeof k === "string"){ o[k.trim()] = (r[k]===null? "": r[k].toString().trim()); } } return o; }
    const resumo = rowsResumo.map(normRow).filter(r=> (r["Fornecedor"] || r["PecasAuditadas"] || r["PecasPorHora"]) );
    const defeitos = rowsDef.map(normRow).filter(r=> (r["Fornecedor"] || r["Qntd"]) );

    // AGREGADORES
    let totalPecas = 0, totalCheckin = 0, totalDef = 0, somaPH=0, contPH=0;
    let totalPhotos = 0;
    const fornecedoresDef = {}, tiposDef = {}, catAgg = {}, respAgg = {};
    const historicoPorDia = {}; // yyyy-mm-dd -> pecas

    // processa Resumo
    resumo.forEach(r=>{
      const d = parseDateStr(r["Data"]);
      const pecas = parseNumber(r["PecasAuditadas"]);
      const check = parseNumber(r["PecasCheckin"]);
      const pHora = parseNumber(r["PecasPorHora"]);
      const cat = (r["Categoria"]||"").toString().trim().toUpperCase();

      totalPecas += pecas;
      totalCheckin += check;
      if(pHora>0){ somaPH += pHora; contPH++; }

      // categorias
      const catNorm = (cat || "OUTROS");
      catAgg[catNorm] = (catAgg[catNorm] || 0) + pecas;

      // historico por dia
      if(d){
        const key = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
        historicoPorDia[key] = (historicoPorDia[key] || 0) + pecas;
      }

      // respons√°veis (se coluna existir)
      const resp = (r["Responsavel"]||"").toString();
      if(resp) respAgg[resp] = (respAgg[resp] || 0) + pecas;
    });

    // processa Defeitos
    const rncSet = new Set();
    defeitos.forEach(r=>{
      const q = parseNumber(r["Qntd"]);
      const forn = (r["Fornecedor"]||"").toString();
      const tipo = (r["TipoAvaria"]||"").toString();
      const photos = parseNumber(r["PhotosCount"]);
      const rncId = (r["RNC_ID"]||"").toString().trim();
      const rncGen = (r["RNC_Generated"]||"").toString().toUpperCase();

      totalDef += q;
      totalPhotos += photos;
      fornecedoresDef[forn] = (fornecedoresDef[forn]||0) + q;
      tiposDef[tipo] = (tiposDef[tipo] || 0) + q;

      if(rncId) rncSet.add(rncId);
      if(rncGen==="SIM" && rncId) rncSet.add(rncId);
    });

    // KPIs
    const prodMedia = contPH ? (somaPH / contPH) : 0;
    const pctCheck = totalPecas ? (totalCheckin / totalPecas) * 100 : 0;
    const pctDefSobreAudit = totalPecas ? (totalDef / totalPecas) * 100 : 0;

    // preencher cards
    document.getElementById("kpiPecas").innerText = totalPecas.toLocaleString();
    // breakdown categorias
    const catDiv = document.getElementById("kpiCategorias"); catDiv.innerHTML = "";
    const catsOrder = ["CAL√áADOS","CALCADOS","VESTUARIOS","VESTU√ÅRIOS","ACESSORIOS","SUPLEMENTOS"];
    // show preferred categories first
    for(const c of catsOrder){
      if(catAgg[c]) catDiv.insertAdjacentHTML("beforeend",`<div class="kpi-mini">${c.replace("CALCADOS","CAL√áADOS")}: <strong>${catAgg[c].toLocaleString()}</strong></div>`);
    }
    // any others
    Object.keys(catAgg).filter(k=>!catsOrder.includes(k)).slice(0,6).forEach(k=>catDiv.insertAdjacentHTML("beforeend",`<div class="kpi-mini">${k}: <strong>${catAgg[k].toLocaleString()}</strong></div>`));

    document.getElementById("kpiCheckPct").innerText = pctCheck.toFixed(1) + " %";
    document.getElementById("kpiCheckA").innerText = totalPecas.toLocaleString();
    document.getElementById("kpiCheckB").innerText = totalCheckin.toLocaleString();

    document.getElementById("kpiDefTotal").innerText = totalDef.toLocaleString();
    document.getElementById("kpiDefPct").innerText = pctDefSobreAudit.toFixed(1) + " %";

    document.getElementById("kpiProd").innerText = prodMedia.toFixed(1);
    document.getElementById("kpiFotos").innerText = totalPhotos.toLocaleString();
    document.getElementById("kpiRNC").innerText = rncSet.size;

    document.getElementById("ultimaLeitura").innerText = new Date().toLocaleString();

    // HISTORICO LINHA (ordenar)
    const diasKeys = Object.keys(historicoPorDia).sort();
    const diasLabels = diasKeys.map(k=>{
      const parts = k.split("-");
      return parts[2].padStart(2,"0") + "/" + parts[1].padStart(2,"0") + "/" + parts[0];
    });
    const diasValues = diasKeys.map(k=>historicoPorDia[k] || 0);

    // TOP fornecedores (ordenar por Qntd)
    const arrFor = Object.entries(fornecedoresDef).sort((a,b)=>b[1]-a[1]);
    const topFor = arrFor.slice(0,10);
    const labelsFor = topFor.map(x=>x[0]); const valsFor = topFor.map(x=>x[1]);

    // tipos
    const arrTipo = Object.entries(tiposDef).sort((a,b)=>b[1]-a[1]);
    const labelsTipo = arrTipo.map(x=>x[0]); const valsTipo = arrTipo.map(x=>x[1]);

    // preencher listas laterais
    const catList = document.getElementById("catList");
    catList.innerHTML = Object.entries(catAgg).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>`<div class="list-item"><div>${x[0]}</div><div style="font-weight:700">${x[1]}</div></div>`).join("");

    const respList = document.getElementById("respList");
    respList.innerHTML = Object.entries(respAgg).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>`<div class="list-item"><div>${x[0]}</div><div style="font-weight:700">${x[1]}</div></div>`).join("");

    // ranking top 3 fornecedores cr√≠ticos
    const top3 = arrFor.slice(0,3);
    const rankDiv = document.getElementById("rankFor");
    rankDiv.innerHTML = top3.map((x,i)=>`<div style="padding:8px 0"><strong>${i+1}. ${x[0]}</strong> ‚Äî ${x[1]} pe√ßas</div>`).join("");
    if(top3.length>0) document.getElementById("top3badge").innerText = `Top 3: ${top3.map(x=>x[0]).join(" ‚Ä¢ ")}`;

    // tabela de defeitos (resumida)
    const tbody = document.querySelector("#tabelaDef tbody");
    tbody.innerHTML = "";
    defeitos.forEach(r=>{
      const d = parseDateStr(r["Data"]);
      const rowHtml = `<tr>
        <td>${formatDate(d)}</td>
        <td>${(r["OR"]||"")}</td>
        <td>${(r["Fornecedor"]||"")}</td>
        <td>${(r["Produto"]||"")}</td>
        <td>${(r["CodigoAvariado"]||"")}</td>
        <td>${(r["TipoAvaria"]||"")}</td>
        <td>${parseNumber(r["Qntd"])}</td>
        <td>${parseNumber(r["PhotosCount"])}</td>
        <td>${(r["RNC_ID"]||"")}</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", rowHtml);
    });

    // GR√ÅFICOS com Chart.js
    // Linha
    const ctxL = document.getElementById("chartLinha").getContext("2d");
    new Chart(ctxL, {
      type: 'line',
      data: { labels: diasLabels, datasets: [{ label: 'Pe√ßas Auditadas', data: diasValues, borderColor: 'var(--azul)', backgroundColor: 'rgba(0,40,94,0.08)', fill:true, tension:0.2, pointRadius:3 }]},
      options: { responsive:true, plugins:{legend:{display:false}}}
    });

    // Bar - fornecedores (top)
    const ctxB = document.getElementById("chartBar").getContext("2d");
    new Chart(ctxB, {
      type:'bar',
      data:{ labels: labelsFor, datasets:[{ label:'Avarias (qntd)', data: valsFor, backgroundColor: 'var(--amarelo)'}]},
      options:{ indexAxis:'y', responsive:true, plugins:{legend:{display:false}}}
    });

    // Donut - tipos
    const ctxD = document.getElementById("chartDonut").getContext("2d");
    new Chart(ctxD, {
      type:'doughnut',
      data:{ labels: labelsTipo, datasets:[{ data: valsTipo, /* cores autom√°ticas */ }]},
      options:{ responsive:true, plugins:{legend:{position:'right'}}}
    });

  }catch(err){
    console.error(err);
    alert("Erro ao gerar dashboard: " + (err.message||err));
  }
}

/* executa */
carregarEDesenhar();
</script>

</body>
</html>
