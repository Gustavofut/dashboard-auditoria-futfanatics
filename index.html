<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DASHBOARD CONTROLE DE QUALIDADE NOTURNO - FutFanatics</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --navy: #001C40;       /* azul escuro FutFanatics */
      --accent: #A4FF00;     /* verde-limão */
      --muted: #f5f6f7;
      --card-radius: 12px;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, sans-serif;}
    body{background:var(--bg); color:var(--navy); padding:18px;}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px;}
    header h1{margin:0;font-size:20px;color:var(--navy);}
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr 420px;
      gap:18px;
      align-items:start;
    }

    /* Left column */
    .col-left{display:flex;flex-direction:column;gap:18px;}
    .card{background:#fff;border-radius:var(--card-radius);box-shadow:var(--card-shadow);padding:16px;border:2px solid rgba(0,0,0,0.04);}
    .kpi-large{font-size:48px;font-weight:700;text-align:center;color:var(--navy);}
    .kpi-label{text-align:center;font-size:13px;color:#333;margin-top:6px;}
    .mini-list{display:flex;flex-direction:column;gap:6px;margin-top:6px;}
    .mini-item{display:flex;justify-content:space-between;padding:6px;background:var(--muted);border-radius:8px;font-size:13px}

    /* Center */
    .col-center{display:flex;flex-direction:column;gap:18px;}
    .chart-card{background:#fff;border-radius:var(--card-radius);padding:12px;box-shadow:var(--card-shadow);}
    .chart-row{display:flex;gap:12px;align-items:center;}
    .legend{display:flex;gap:10px;align-items:center;font-size:13px}
    .legend-swatch{width:14px;height:14px;border-radius:3px}
    
    /* Right */
    .col-right{display:flex;flex-direction:column;gap:18px;}
    .small-title{font-weight:700;color:var(--navy);font-size:13px;margin-bottom:8px}
    footer{margin-top:18px;font-size:12px;color:#666}
    
    /* Responsive */
    @media (max-width:1100px){
      .grid{grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>DASHBOARD CONTROLE DE QUALIDADE NOTURNO - FutFanatics</h1>
      <div style="font-size:13px;color:#666">Período: <span id="periodo-text">--</span></div>
    </div>
  </header>

  <div class="grid">
    <div class="col-left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:12px;color:#666">PEÇAS AUDITADAS</div>
            <div class="kpi-large" id="kpi-pecas">--</div>
            <div class="kpi-label">total do período</div>
          </div>
          <div style="width:120px">
            <div style="font-size:12px;color:#666">TAXA DE NÃO CONFORMIDADE</div>
            <div style="font-weight:700;font-size:24px;color:var(--navy)" id="kpi-taxa">--</div>
            <div style="font-size:12px;color:#999" id="kpi-taxa-qnt">--</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="small-title">Distribuição por categoria</div>
          <div class="mini-list" id="categoria-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="small-title">Top 3 Fornecedores Críticos </div>
        <div id="fornecedores-list"></div>
        <div style="margin-top:12px" class="small-title">Tipos de Avaria mais frequentes</div>
        <div id="tipos-list"></div>
      </div>
    </div>

    <div class="col-center">
      <div class="chart-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small-title">Peças Conferidas (Check-in) vs Peças Auditadas</div>
          <div style="display:flex;gap:12px;align-items:center">
            <div class="legend"><div class="legend-swatch" style="background:#1976d2"></div> Conferidas</div>
            <div class="legend"><div class="legend-swatch" style="background:#0b5f3a"></div> Auditadas</div>
            <div class="legend"><div class="legend-swatch" style="background:gold"></div> Média peças H/H</div>
          </div>
        </div>
        <canvas id="chart-checkin" height="150"></canvas>
        <div style="font-size:12px;color:#666;margin-top:8px" id="meta-note"></div>
      </div>

      <div class="chart-card" style="display:flex;gap:12px;align-items:center;">
        <div style="flex:1">
          <div class="small-title">Peças por Categoria (Check-in)</div>
          <canvas id="chart-categories" height="120"></canvas>
        </div>
        <div style="width:220px">
          <div class="small-title">RNC / FOTOS (OR)</div>
          <div style="font-size:24px;font-weight:700;color:var(--navy)"><span id="rnc-num">--</span> RNC</div>
          <div style="font-size:24px;font-weight:700;color:var(--navy)"><span id="fotos-num">--</span> FOTOS</div>
        </div>
      </div>
    </div>

    <div class="col-right">
      <div class="card">
        <div class="small-title">Linha do Tempo Mensal</div>
        <div style="height: 200px;">
            <canvas id="chart-monthly"></canvas>
        </div>
        <div style="font-size:12px;color:#666;margin-top:10px">
            Histórico anual alimentado pela aba HISTORICO_ANUAL.
        </div>
      </div>

      <div class="card">
        <div class="small-title">Média Peças H/H (média das médias)</div>
        <div style="font-size:36px;font-weight:800;color:var(--navy)" id="kpi-hh">--</div>
      </div>

      <div class="card">
        <div class="small-title">Resumo rápido</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;justify-content:space-between"><div>Peças Conferidas</div><div id="sum-conferidas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>Peças Auditadas</div><div id="sum-auditadas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>% Auditado sobre Conferido</div><div id="pct-auditado">--</div></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div>Gerado automaticamente. Para alterar as fontes de dados, atualize o Google Sheets.</div>
  </footer>

<script>
/* ========================================================
   CONFIGURAÇÃO - COLE SEU ID AQUI
   ======================================================== */
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0"; // <--- VERIFIQUE SE ESTE É O ID CORRETO

/* Nomes das Abas (Devem ser iguais aos da planilha) */
const SHEET_NAMES = {
  audit: "1",
  checkin: "2",
  ncr: "3",
  history: "HISTORICO_ANUAL" // Sem acento, conforme instrução
};

/* Mapeamento de Colunas (Nomes exatos na linha 1) */
const COLMAP = {
  audit_date: "Data",
  audit_total: "Peças Auditadas (dia) TOTAL",
  audit_cald: "CALÇADOS",
  audit_vest: "VESTUARIOS",
  audit_acess: "ACESSORIOS",
  audit_supl: "SUPLEMENTOS",
  audit_phh: "Peças por Hora",
  audit_rnc_count: "quantidade de RNC GERADAS",
  audit_fotos: "fotos"
};

/* ========================================================
   LÓGICA DO SISTEMA
   ======================================================== */

function gsheetCsvUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}

function fetchCsvAsJson(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results){ resolve(results.data); },
      error: function(err){ reject(err); }
    });
  });
}

const toNumber = v => {
    if(v===undefined || v===null || v==="") return 0;
    // Tenta limpar R$ e espaços, troca virgula por ponto
    let s = String(v).replace("R$","").replace("%","").trim();
    // Se tiver ponto e virgula (ex: 1.000,50) -> remove ponto milhar, troca virgula decimal
    if(s.includes('.') && s.includes(',')) s = s.replace(/\./g,'').replace(',','.');
    else if(s.includes(',')) s = s.replace(',','.');
    return parseFloat(s) || 0;
};

/* 1. Processamento Diário (Esquerda/Centro) */
function computeKpis(auditRows, checkinRows, ncrRows){
  let totalAuditadas = 0;
  let categoriesAudit = {CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0};
  let phhList = [];
  let rncSum = 0;
  let fotosSum = 0;
  let datas = [];

  auditRows.forEach(r=>{
    totalAuditadas += toNumber(r[COLMAP.audit_total]);
    categoriesAudit.CALÇADOS += toNumber(r[COLMAP.audit_cald]);
    categoriesAudit.VESTUARIOS += toNumber(r[COLMAP.audit_vest]);
    categoriesAudit.ACESSORIOS += toNumber(r[COLMAP.audit_acess]);
    categoriesAudit.SUPLEMENTOS += toNumber(r[COLMAP.audit_supl]);
    const ph = toNumber(r[COLMAP.audit_phh]); if(ph) phhList.push(ph);
    rncSum += toNumber(r[COLMAP.audit_rnc_count]);
    fotosSum += toNumber(r[COLMAP.audit_fotos]);
    if(r[COLMAP.audit_date]) datas.push(r[COLMAP.audit_date]);
  });

  // Checkin por Data
  const checkByDate = {};
  let totalConferidas = 0;
  const check_categories = { CALÇADOS:0, VESTUARIOS:0, ACESSORIOS:0, SUPLEMENTOS:0 };

  checkinRows.forEach(r => {
    const d = r["Data"] || r["data"] || r["DATA"] || '';
    if(!d) return;
    if(!checkByDate[d]) checkByDate[d] = { total:0 };
    
    const valTotal = toNumber(r["CONFERIDAS TOTAL"] ?? r["CONFERIDAS"] ?? r["PCONFERIDAS"] ?? '0');
    checkByDate[d].total += valTotal;
    totalConferidas += valTotal;

    check_categories.CALÇADOS += toNumber(r["CALÇADOS"]||0);
    check_categories.VESTUARIOS += toNumber(r["VESTUARIOS"]||0);
    check_categories.ACESSORIOS += toNumber(r["ACESSORIOS"]||0);
    check_categories.SUPLEMENTOS += toNumber(r["SUPLEMENTOS"]||0);
  });

  // NCR aggregation
  const fornecedores = {};
  const tipos = {};
  let totalAvariados = 0;
  ncrRows.forEach(r=>{
    const qtd = toNumber(r["QNTD"]);
    const f = r["FORNECEDOR"] || "SEM FORNECEDOR";
    const t = r["TIPO DE AVARIA"] || "OUTRO";
    fornecedores[f] = (fornecedores[f]||0) + qtd;
    tipos[t] = (tipos[t]||0) + qtd;
    totalAvariados += qtd;
  });

  const taxaNaoConformidade = totalAuditadas>0 ? totalAvariados/totalAuditadas : 0;
  const mediaPhh = phhList.length>0 ? phhList.reduce((a,b)=>a+b,0)/phhList.length : 0;
  const pctAuditadoSobreConferido = totalConferidas>0 ? (totalAuditadas / totalConferidas) : 0;

  return {
    period: {min: datas.length?datas[0]:null, max: datas.length?datas[datas.length-1]:null},
    totalAuditadas,
    categoriesAudit,
    mediaPhh,
    totalConferidas,
    check_categories,
    totalAvariados,
    taxaNaoConformidade,
    rncSum,
    fotosSum,
    fornecedores,
    tipos,
    pctAuditadoSobreConferido
  };
}

function renderKpis(k){
  document.getElementById('kpi-pecas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('kpi-hh').innerText = k.mediaPhh.toFixed(1);
  document.getElementById('rnc-num').innerText = k.rncSum;
  document.getElementById('fotos-num').innerText = k.fotosSum;
  document.getElementById('sum-conferidas').innerText = k.totalConferidas.toLocaleString('pt-BR');
  document.getElementById('sum-auditadas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('pct-auditado').innerText = (k.pctAuditadoSobreConferido*100).toFixed(1)+'%';
  document.getElementById('kpi-taxa').innerText = (k.taxaNaoConformidade*100).toFixed(1)+'%';
  document.getElementById('kpi-taxa-qnt').innerText = `${k.totalAvariados} peças`;

  // Categorias
  const catDiv = document.getElementById('categoria-list'); catDiv.innerHTML='';
  ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'].forEach(cat=>{
    const el = document.createElement('div'); el.className='mini-item';
    el.innerHTML = `<div style="font-weight:600">${cat}</div><div>${k.categoriesAudit[cat]||0}</div>`;
    catDiv.appendChild(el);
  });

  // Fornecedores
  const fornArr = Object.entries(k.fornecedores || {}).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const fornDiv = document.getElementById('fornecedores-list'); fornDiv.innerHTML='';
  fornArr.forEach((f,i)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
    row.innerHTML = `<div>${i+1}º - ${f[0]}</div><div style="font-weight:700">${f[1]}</div>`;
    fornDiv.appendChild(row);
  });

  // Tipos
  const tiposArr = Object.entries(k.tipos || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const tiposDiv = document.getElementById('tipos-list'); tiposDiv.innerHTML='';
  tiposArr.forEach(t=>{
    const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.padding='4px 0';
    r.innerHTML = `<div>${t[0]}</div><div>${t[1]}</div>`;
    tiposDiv.appendChild(r);
  });

  document.getElementById('periodo-text').innerText = (k.period.min) ? `${k.period.min} → ${k.period.max}` : '--';
}

function drawCharts(k, auditRows, checkinRows){
    // Chart 1: Checkin vs Audit vs PH
    const labels = [ 'Total Período' ]; 
    // Se quiser gráfico por dia, precisa agregar auditRows por dia igual fizemos no checkin.
    // Para simplificar e garantir funcionamento, vamos mostrar Totais:
    const ctx = document.getElementById('chart-checkin').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label:'Conferidas', data: [k.totalConferidas], backgroundColor:'#1976d2' },
          { label:'Auditadas', data: [k.totalAuditadas], backgroundColor:'#0b5f3a' },
          // Usando eixo direito para PH
          { label:'Média Peças H/H', data: [k.mediaPhh], type:'line', borderColor:'gold', tension:0.1, yAxisID:'y1' }
        ]
      },
      options: {
        responsive:true,
        scales: {
            y: { beginAtZero:true, position:'left' },
            y1: { beginAtZero:true, position:'right', grid:{display:false} }
        }
      }
    });

    // Chart 2: Categorias
    const catLabels = ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'];
    const catData = catLabels.map(c=>k.check_categories[c] || 0);
    new Chart(document.getElementById('chart-categories'), {
      type:'bar',
      data: { labels: catLabels, datasets: [{ label:'Check-in', data: catData, backgroundColor:'#001C40' }] },
      options: { responsive:true, plugins:{legend:{display:false}} }
    });
}

/* ========================================================
   2. PROCESSAMENTO DO HISTÓRICO ANUAL (Linha do Tempo)
   ======================================================== */
function processAndDrawHistory(historyRows) {
  const labels = [];
  const dataConf = [];
  const dataAud = [];
  const dataNconf = [];

  historyRows.forEach(row => {
    if (!row["MES"]) return; 
    labels.push(row["MES"]);
    dataConf.push(toNumber(row["CONFERIDAS"]));
    dataAud.push(toNumber(row["AUDITADAS"]));
    dataNconf.push(toNumber(row["PCT_NCONF"]));
  });

  const ctx = document.getElementById("chart-monthly").getContext("2d");
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Conferidas',
          data: dataConf,
          backgroundColor: '#3e73c3', // Azul (Fundo - Largo)
          order: 3,
          barPercentage: 0.9,
          categoryPercentage: 0.8,
          yAxisID: 'y'
        },
        {
          label: 'Auditadas',
          data: dataAud,
          backgroundColor: '#8ad05b', // Verde (Meio - Médio)
          order: 2,
          barPercentage: 0.5,
          yAxisID: 'y'
        },
        {
          label: '% Não Conforme',
          data: dataNconf,
          backgroundColor: '#ff0000', // Vermelho (Frente - Fino)
          order: 1,
          barPercentage: 0.2,
          yAxisID: 'y1' // Eixo da direita para porcentagem
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true, // Isso garante que fiquem uma em cima da outra
        },
        y: {
          beginAtZero: true,
          position: 'left',
          title: { display: true, text: 'Quantidade' }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { display: false },
          title: { display: true, text: '%' }
        }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) label += ': ';
                    if (context.dataset.yAxisID === 'y1') {
                         return label + context.parsed.y + '%';
                    }
                    return label + context.parsed.y.toLocaleString('pt-BR');
                }
            }
        }
      }
    }
  });
}

/* ========================================================
   INICIALIZAÇÃO (MAIN)
   ======================================================== */
async function init(){
  try{
    // Baixar todas as abas
    const [auditRows, checkinRows, ncrRows, historyRows] = await Promise.all([
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.audit)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.checkin)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.ncr)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.history))
    ]);

    console.log("Dados Carregados:", {auditRows, checkinRows, historyRows});

    // 1. Renderizar KPIs e Gráficos Diários
    const k = computeKpis(auditRows, checkinRows, ncrRows);
    renderKpis(k);
    drawCharts(k, auditRows, checkinRows);

    // 2. Renderizar Histórico Mensal
    if(historyRows.length > 0) {
        processAndDrawHistory(historyRows);
    } else {
        console.warn("Aba HISTORICO_ANUAL vazia ou não encontrada.");
    }

  } catch(err){
    console.error(err);
    document.body.insertAdjacentHTML('beforeend', 
      `<div style="margin-top:20px;padding:20px;background:#ffebee;color:#c62828;border-radius:8px">
         <strong>Erro ao carregar dados:</strong> ${err.message}. <br><br>
         Verifique se o ID da planilha está correto e se ela foi "Publicada na Web" (Arquivo > Compartilhar > Publicar na Web).
      </div>`
    );
  }
}

init();
</script>
</body>
</html>
