<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Auditoria - FutFanatics</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- PapaParse para CSV do Google Sheets -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --navy: #001C40;       /* azul escuro FutFanatics */
      --accent: #A4FF00;     /* verde-limão */
      --muted: #f5f6f7;
      --card-radius: 12px;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:var(--bg); color:var(--navy); padding:18px;}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px;}
    header h1{margin:0;font-size:20px;color:var(--navy);}
    .grid{display:grid;grid-template-columns:320px 1fr 420px;gap:18px;align-items:start;}
    .col-left{display:flex;flex-direction:column;gap:18px;}
    .card{background:#fff;border-radius:var(--card-radius);box-shadow:var(--card-shadow);padding:16px;border:2px solid rgba(0,0,0,0.04);}
    .kpi-large{font-size:48px;font-weight:700;text-align:center;color:var(--navy);}
    .kpi-label{text-align:center;font-size:13px;color:#333;margin-top:6px;}
    .mini-list{display:flex;flex-direction:column;gap:6px;margin-top:6px;}
    .mini-item{display:flex;justify-content:space-between;padding:6px;background:var(--muted);border-radius:8px;font-size:13px}
    .col-center{display:flex;flex-direction:column;gap:18px;}
    .chart-card{background:#fff;border-radius:var(--card-radius);padding:12px;box-shadow:var(--card-shadow);}
    .legend{display:flex;gap:10px;align-items:center;font-size:13px}
    .legend-swatch{width:14px;height:14px;border-radius:3px}
    .col-right{display:flex;flex-direction:column;gap:18px;}
    .small-title{font-weight:700;color:var(--navy);font-size:13px;margin-bottom:8px}
    footer{margin-top:18px;font-size:12px;color:#666}
    @media (max-width:1100px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <header>
    <img src="" alt="Logo" style="width:44px;height:44px;background:var(--navy);border-radius:8px">
    <div>
      <h1>Dashboard Auditoria - FutFanatics</h1>
      <div style="font-size:13px;color:#666">
        <!-- AJUSTE FUT 04: filtro de período -->
        Período: <input type="date" id="start-date"> —
        <input type="date" id="end-date">
        <button id="filter-btn" style="background:var(--accent);border:none;border-radius:6px;padding:4px 10px;font-weight:600;">Filtrar</button>
        <span id="periodo-text" style="margin-left:8px"></span>
      </div>
    </div>
  </header>

  <div class="grid">
    <div class="col-left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:12px;color:#666">PEÇAS AUDITADAS</div>
            <div class="kpi-large" id="kpi-pecas">--</div>
            <div class="kpi-label">total do período</div>
          </div>
          <div style="width:120px">
            <div style="font-size:12px;color:#666">TAXA DE NÃO CONFORMIDADE</div>
            <div style="font-weight:700;font-size:24px;color:var(--navy)" id="kpi-taxa">--</div>
            <div style="font-size:12px;color:#999" id="kpi-taxa-qnt">--</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="small-title">Distribuição por categoria</div>
          <div class="mini-list" id="categoria-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="small-title">Fornecedores Críticos (top 3)</div>
        <div id="fornecedores-list"></div>
        <div style="margin-top:12px" class="small-title">Tipos de Avaria mais frequentes</div>
        <div id="tipos-list"></div>
      </div>
    </div>

    <div class="col-center">
      <div class="chart-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small-title">Peças Conferidas (Check-in) vs Peças Auditadas</div>
          <div style="display:flex;gap:12px;align-items:center">
            <div class="legend"><div class="legend-swatch" style="background:#1976d2"></div> Conferidas</div>
            <div class="legend"><div class="legend-swatch" style="background:#0b5f3a"></div> Auditadas</div>
            <div class="legend"><div class="legend-swatch" style="background:gold"></div> Média peças H/H</div>
          </div>
        </div>
        <canvas id="chart-checkin" height="150"></canvas>
        <div style="font-size:12px;color:#666;margin-top:8px" id="meta-note"></div>
      </div>

      <div class="chart-card" style="display:flex;gap:12px;align-items:center;">
        <div style="flex:1">
          <div class="small-title">Peças por Categoria (Auditadas vs Conferidas)</div>
          <canvas id="chart-categories" height="120"></canvas>
        </div>
        <div style="width:220px">
          <div class="small-title">RNC / Fotos (período)</div>
          <div style="font-size:24px;font-weight:700;color:var(--navy)"><span id="rnc-num">--</span> RNC</div>
          <div style="font-size:20px;font-weight:600;color:#444;margin-top:6px"><span id="fotos-num">--</span> Fotos</div>
        </div>
      </div>
    </div>

    <div class="col-right">
      <div class="card">
        <div class="small-title">Média Peças H/H (média das médias)</div>
        <div style="font-size:36px;font-weight:800;color:var(--navy)" id="kpi-hh">--</div>
        <div style="font-size:13px;color:#666">Média diária das colunas "Peças por Hora"</div>
      </div>
      <div class="card">
        <div class="small-title">Resumo rápido</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;justify-content:space-between"><div>Peças Conferidas</div><div id="sum-conferidas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>Peças Auditadas</div><div id="sum-auditadas">--</div></div>
          <div style="display:flex;justify-content:space-between"><div>% Auditado sobre Conferido</div><div id="pct-auditado">--</div></div>
        </div>
      </div>
    </div>
  </div>

  <footer><div>Gerado automaticamente. Atualize os dados no Google Sheets para refletir no painel.</div></footer>

<script>
// CONFIGURAÇÃO
const SHEET_ID = "1RisWgpsGELH184pSKGB77axrCd7xMfVdBkeK3_HGWP0";
const SHEET_NAMES = { audit: "1", checkin: "2", ncr: "3" };
const COLMAP = {
  audit_date: "Data",
  audit_total: "Peças Auditadas (dia) TOTAL",
  audit_cald: "CALÇADOS",
  audit_vest: "VESTUARIOS",
  audit_acess: "ACESSORIOS",
  audit_supl: "SUPLEMENTOS",
  audit_phh: "Peças por Hora",
  audit_rnc_count: "quantidade de RNC GERADAS",
  audit_fotos: "quantidade de FOTOS "
};
function gsheetCsvUrl(sheetName){return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;}
function fetchCsvAsJson(url){return new Promise((resolve,reject)=>{Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:err=>reject(err)});});}

// AJUSTE FUT 01 - separador de milhar e 1 casa decimal em percentuais
function renderKpis(k){
  document.getElementById('kpi-pecas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('kpi-hh').innerText = k.mediaPhh ? k.mediaPhh.toFixed(1) : '--';
  document.getElementById('rnc-num').innerText = k.rncSum;
  document.getElementById('fotos-num').innerText = k.fotosSum;
  document.getElementById('sum-conferidas').innerText = k.totalConferidas.toLocaleString('pt-BR');
  document.getElementById('sum-auditadas').innerText = k.totalAuditadas.toLocaleString('pt-BR');
  document.getElementById('pct-auditado').innerText = k.pctAuditadoSobreConferido ? (k.pctAuditadoSobreConferido*100).toFixed(1)+'%' : '--';
  document.getElementById('kpi-taxa').innerText = k.taxaNaoConformidade ? (k.taxaNaoConformidade*100).toFixed(1)+'%' : '--';
  document.getElementById('kpi-taxa-qnt').innerText = k.totalAvariados ? `${k.totalAvariados.toLocaleString('pt-BR')} peças` : '';

  // categorias
  const catDiv=document.getElementById('categoria-list');catDiv.innerHTML='';
  ['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'].forEach(cat=>{
    const el=document.createElement('div');el.className='mini-item';
    el.innerHTML=`<div style="font-weight:600">${cat}</div><div>${k.categoriesAudit[cat].toLocaleString('pt-BR')||0}</div>`;
    catDiv.appendChild(el);
  });
  // fornecedores top3
  const fornArr=Object.entries(k.fornecedores||{}).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const fornDiv=document.getElementById('fornecedores-list');fornDiv.innerHTML='';
  fornArr.forEach((f,i)=>{const row=document.createElement('div');row.style.display='flex';row.style.justifyContent='space-between';row.style.padding='6px 0';row.innerHTML=`<div>${i+1}º - ${f[0]}</div><div style="font-weight:700">${f[1]}</div>`;fornDiv.appendChild(row);});
  // tipos
  const tiposArr=Object.entries(k.tipos||{}).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const tiposDiv=document.getElementById('tipos-list');tiposDiv.innerHTML='';
  tiposArr.forEach(t=>{const r=document.createElement('div');r.style.display='flex';r.style.justifyContent='space-between';r.style.padding='4px 0';r.innerHTML=`<div>${t[0]}</div><div>${t[1]}</div>`;tiposDiv.appendChild(r);});
  document.getElementById('periodo-text').innerText = (k.period.min && k.period.max)?`${k.period.min} → ${k.period.max}`:'--';
}

// AJUSTE FUT 02 - gráfico por dia, pontos vermelhos e comparação categorias
let chartCheckin=null, chartCats=null;
function drawCharts(k,auditRows,checkinRows){
  const dates=[...new Set(auditRows.map(r=>r["Data"]).filter(Boolean))];
  const byDate={};
  auditRows.forEach(r=>{
    const d=r["Data"];
    if(!byDate[d]) byDate[d]={audit:0,ph:0,check:0};
    byDate[d].audit+=Number(r[COLMAP.audit_total]||0);
    byDate[d].ph+=Number(r[COLMAP.audit_phh]||0);
  });
  checkinRows.forEach(r=>{
    const d=r["Data"];if(!byDate[d]) byDate[d]={audit:0,ph:0,check:0};
    byDate[d].check+=Number(r["CONFERIDAS TOTAL"]||r["CONFERIDAS"]||0);
  });
  const labels=Object.keys(byDate);
  const auditData=labels.map(l=>byDate[l].audit);
  const checkData=labels.map(l=>byDate[l].check);
  const phData=labels.map(l=>byDate[l].ph);
  const pctData=labels.map(l=>byDate[l].check>0?(byDate[l].audit/byDate[l].check)*100:0);
  const below25=labels.map((_,i)=>pctData[i]<25?phData[i]:null);

  const ctx=document.getElementById('chart-checkin').getContext('2d');
  if(chartCheckin) chartCheckin.destroy();
  chartCheckin=new Chart(ctx,{
    data:{
      labels,
      datasets:[
        {type:'bar',label:'Conferidas',data:checkData,backgroundColor:'#1976d2'},
        {type:'bar',label:'Auditadas',data:auditData,backgroundColor:'#0b5f3a'},
        {type:'line',label:'Média Pçs H/H',data:phData,borderColor:'#FFD700',borderWidth:2,tension:0.3,pointRadius:4},
        {type:'scatter',label:'Dias <25%',data:below25.map((v,i)=>v!==null?{x:labels[i],y:phData[i]}:null).filter(Boolean),
         pointBackgroundColor:'#FF0000',pointBorderColor:'#FF0000',showLine:false,pointRadius:6}
      ]
    },
    options:{
      responsive:true,
      scales:{y:{beginAtZero:true}},
      plugins:{legend:{position:'top'}}
    }
  });
  document.getElementById('meta-note').innerText=`Meta 25%: ${below25.filter(v=>v!==null).length} dias abaixo`;

  // categorias comparativas
  const catLabels=['CALÇADOS','VESTUARIOS','ACESSORIOS','SUPLEMENTOS'];
  const auditCats=catLabels.map(c=>k.categoriesAudit[c]);
  const checkCats=catLabels.map(c=>k.check_categories[c]);
  const ctx2=document.getElementById('chart-categories').getContext('2d');
  if(chartCats) chartCats.destroy();
  chartCats=new Chart(ctx2,{
    type:'bar',
    data:{labels:catLabels,
      datasets:[
        {label:'Auditadas',data:auditCats,backgroundColor:'#0b5f3a'},
        {label:'Conferidas',data:checkCats,backgroundColor:'#1976d2'}
      ]},
    options:{responsive:true,plugins:{legend:{position:'top'}}}
  });
}

// Filtragem por período
document.getElementById('filter-btn').addEventListener('click',()=>init());

async function init(){
  try{
    const [auditRows,checkinRows,ncrRows]=await Promise.all([
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.audit)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.checkin)),
      fetchCsvAsJson(gsheetCsvUrl(SHEET_NAMES.ncr))
    ]);
    const start=document.getElementById('start-date').value;
    const end=document.getElementById('end-date').value;
    const filteredAudit=auditRows.filter(r=>!start||!end|| (r["Data"]>=start&&r["Data"]<=end));
    const filteredCheck=checkinRows.filter(r=>!start||!end|| (r["Data"]>=start&&r["Data"]<=end));
    const k=computeKpis(filteredAudit,filteredCheck,ncrRows);
    renderKpis(k);
    drawCharts(k,filteredAudit,filteredCheck);
  }catch(err){console.error(err);document.body.insertAdjacentHTML('beforeend',`<div style="color:#900">Erro: ${err}</


